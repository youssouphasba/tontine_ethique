rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isMember(resourceData) {
      return isSignedIn() && (
        resourceData.creatorId == request.auth.uid || 
        request.auth.uid in resourceData.memberIds
      );
    }

    function isAdmin() {
      // Check for Firebase Custom Claims ONLY (most secure method)
      // Admin claims are set via Firebase Admin SDK in Cloud Functions
      // SECURITY: Email pattern matching removed to prevent compromised email attacks
      return isSignedIn() &&
        (request.auth.token.admin == true ||
         request.auth.token.super_admin == true);
    }
    
    // --- COLLECTIONS ---

    // USERS: Public Read (Profiles), Owner Write + Admin
    match /users/{userId} {
      allow read: if isSignedIn();
      allow update: if isSignedIn() && (request.auth.uid == userId 
        && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['subscriptionStatus', 'isPremium', 'role', 'stripeConnectAccountId', 'balance', 'honorScore', 'lastScoreUpdate']))
        || isAdmin();
      allow create: if isSignedIn() && request.auth.uid == userId; 
      
      // E2EE Keys
      match /keys/{keyId} {
        allow read: if isSignedIn(); // Public Keys are public
        allow write: if isSignedIn() && request.auth.uid == userId;
      }
      
      // Following: User can manage their own following list
      match /following/{targetId} {
        allow read: if isSignedIn();
        allow write: if isSignedIn() && request.auth.uid == userId;
      }
      
      // Followers: Any authenticated user can add/remove themselves as follower
      match /followers/{followerId} {
        allow read: if isSignedIn();
        allow write: if isSignedIn() && request.auth.uid == followerId;
      }
      
      // Notifications
      match /notifications/{notificationId} {
        allow read: if isSignedIn() && request.auth.uid == userId;
        allow write: if isSignedIn();
      }
    }

    // ENTITLEMENTS: Server-Side Authority + Admin Support
    match /entitlements/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow write: if isAdmin(); // Admin can manually fix entitlements
    }

    // PLANS: Public Read, Admin Write
    match /plans/{planId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // AUDIT LOGS: Client Creation allowed
    match /audit_logs/{logId} {
      allow create: if isSignedIn();
      allow read: if isAdmin();
    }

    // CHAT & CONVERSATIONS (E2EE)
    match /conversations/{conversationId} {
       // Check if auth.uid is in the participants array of the conversation document
       allow read, write: if isSignedIn() && request.auth.uid in resource.data.participants;
       
       match /messages/{messageId} {
         // Inherits check from parent for existing messages, 
         // but for creation, check if the user is a participant
         allow read: if isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
         allow create: if isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
       }
    }

    // ================= TONTINES (Core Business Data) =================
    // TONTINES: Members Only + Admin Oversight
    match /tontines/{tontineId} {
      // Read: Public Get (Invitations), Members/Admin List
      allow get: if true; 
      allow list: if isSignedIn() || isAdmin();
      
      // Create: Any authenticated user
      // limit checks removed here (moved to Cloud Function/App logic) to prevent Rule complexity errors
      // Create: Any authenticated user, but must assign themselves as creator
      allow create: if isSignedIn() 
        && request.resource.data.creatorId == request.auth.uid
        && request.resource.data.status == 'pending';

      // Update: Members/Creator Only OR Approved user finalizing membership
      allow update: if isMember(resource.data) || isAdmin() || (
        isSignedIn() && 
        request.auth.uid in resource.data.pendingSignatureIds &&
        request.resource.data.memberIds.hasAll(resource.data.memberIds.concat([request.auth.uid])) &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['memberIds', 'pendingSignatureIds'])
      );
      
      // Delete: Only Creator (and maybe only if empty/pending)
      allow delete: if isSignedIn() && request.auth.uid == resource.data.creatorId;
      
      // Circle Chat Messages: Restricted to members of the tontine
      match /messages/{messageId} {
        allow read, write: if isMember(get(/databases/$(database)/documents/tontines/$(tontineId)).data);
      }

      // V15: Voting for Payout Order
      match /votes/{voteId} {
        // Only members can read/write votes
        allow read, write: if isMember(get(/databases/$(database)/documents/tontines/$(tontineId)).data);
      }

      // Guarantee Events
      match /guarantee_events/{eventId} {
        allow read: if isMember(get(/databases/$(database)/documents/tontines/$(tontineId)).data) || isAdmin();
        // Writes are usually done by Cloud Functions (backend), so no client write needed generally, 
        // unless we allow manual triggers by admin/creator? Let's restrict to server-side for now or purely Admin if needed.
        // Actually, executeGuarantee is a Cloud Function, so it writes with Admin SDK (bypasses rules).
        // So read-only for clients is fine.
      }
    }

    // ================= TRANSACTIONS (Financial Records) =================
    // ROOT Transactions: Server-Side Authority (Secure)
    match /transactions/{transactionId} {
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid || 
        resource.data.tontineCreatorId == request.auth.uid
      );
      allow write: if false; // SERVER-SIDE ONLY
    }
    
    // USER Transactions: Client-Side Mirror (for App logic)
    // Protected: Owner only
    match /users/{userId}/transactions/{txId} {
       allow read, create: if isSignedIn() && request.auth.uid == userId;
       allow update, delete: if false; // Immutable ledger
    }
    
    // ================= MAN SEPA MANDATES (Sensitive) =================
    match /mandates/{mandateId} {
       allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
       allow write: if false; // SERVER-SIDE ONLY
    }

    // ================= SUPPORT TICKETS =================
    match /support_tickets/{ticketId} {
      allow read: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
      
      match /messages/{messageId} {
        allow read, create: if isSignedIn();
      }
    }

    // ================= SOCIAL ACTIVITIES =================
    match /activities/{activityId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
    }

    // ================= JOIN REQUESTS =================
    match /join_requests/{requestId} {
      allow create: if isSignedIn() && request.resource.data.requesterId == request.auth.uid;
      allow read: if isSignedIn() && (
        resource.data.requesterId == request.auth.uid || 
        isAdmin() ||
        get(/databases/$(database)/documents/tontines/$(resource.data.circleId)).data.creatorId == request.auth.uid
      );
      allow update, delete: if isSignedIn() && (
        resource.data.requesterId == request.auth.uid || 
        isAdmin() ||
        get(/databases/$(database)/documents/tontines/$(resource.data.circleId)).data.creatorId == request.auth.uid
      );
    }

    // ================= WEBHOOK LOGS (Audit) =================
    // Internal use only.
    match /webhook_logs/{logId} {
      allow read, write: if false;
    }

    // ================= ENTERPRISE & CORPORATE =================
    match /enterprises/{enterpriseId} {
       allow read: if isSignedIn(); // Public profile or employee check
       allow write: if isAdmin();
    }

    match /ad_campaigns/{campaignId} {
       allow read: if true; // Ads are public
       allow write: if isAdmin() || (isSignedIn() && resource.data.merchantId == request.auth.uid);
    }
    
    // ================= ADMIN & COMPLIANCE =================
    
    // WAIVERS (DÃ©rogations)
    match /waivers/{waiverId} {
      allow create: if isSignedIn(); // Any user can request a waiver
      allow read: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
      allow update: if isAdmin(); // Only Admin can approve/reject
    }

    // BROADCASTS (Annonces)
    match /broadcasts/{broadcastId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // AI LOGS (Safety Monitoring)
    match /ai_logs/{logId} {
      allow create: if isSignedIn(); // Cloud Function or Client Service logs it
      allow read: if isAdmin();
    }
    
    // ================= MERCHANTS & SHOPS =================
    match /merchants/{merchantId} {
       allow read: if true; // Public store profile
       allow write: if isSignedIn() && request.auth.uid == merchantId;
    }

    match /shops/{shopId} {
       allow read: if true;
       allow write: if isSignedIn() && (
         resource.data.merchantId == request.auth.uid ||
         get(/databases/$(database)/documents/merchants/$(request.auth.uid)).data != null
       );
    }

    match /products/{productId} {
       allow read: if true;
       allow write: if isSignedIn() && get(/databases/$(database)/documents/merchants/$(request.auth.uid)).data != null;
    }

    match /enterprise_overrides/{companyId} {
      // Allow read for authenticated users (app logic might check limits)
      // Ideally restrict to company members, but for now matching flexible requirements
      allow read: if isSignedIn();
      // Write: STRICTLY ADMIN ONLY
      allow write: if isAdmin();
    }

    match /limit_requests/{requestId} {
      // Read: Requester or Admin
      allow read: if isSignedIn() && (
        resource.data.requester_id == request.auth.uid ||
        isAdmin()
      );
      // Create: Any authenticated company admin (client-side enforcement)
      allow create: if isSignedIn();
      // Update: Admin only (approvals)
      allow update: if isAdmin();
    }

    // ================= KYC & VERIFICATION =================

    // KYC Requests: User submits, Admin reviews
    match /kyc_requests/{requestId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
      allow update: if isAdmin();
    }

    // Liveness Checks: Biometric verification
    match /liveness_checks/{checkId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
      allow update: if isAdmin();
    }

    // Merchant KYC
    match /merchant_kyc/{kycId} {
      allow create: if isSignedIn() && request.resource.data.merchantId == request.auth.uid;
      allow read: if isSignedIn() && (resource.data.merchantId == request.auth.uid || isAdmin());
      allow update: if isAdmin();
    }

    // Merchant KYC Documents
    match /merchant_kyc_documents/{docId} {
      allow create: if isSignedIn();
      allow read: if isSignedIn() && (resource.data.merchantId == request.auth.uid || isAdmin());
      allow update, delete: if isAdmin();
    }

    // ================= ADMIN DASHBOARD =================

    // Admin Alerts: Admin-only access
    match /admin_alerts/{alertId} {
      allow read, write: if isAdmin();
    }

    // Admin Audit Logs: Immutable admin action history
    match /admin_audit_logs/{logId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if false; // Immutable
    }

    // Fraud Alerts
    match /fraud_alerts/{alertId} {
      allow read: if isAdmin();
      allow create: if isSignedIn(); // System or user can report
      allow update: if isAdmin();
    }

    // ================= INVITATIONS =================

    // General Invitations
    match /invitations/{inviteId} {
      allow create: if isSignedIn();
      allow read: if isSignedIn() && (
        resource.data.senderId == request.auth.uid ||
        resource.data.recipientId == request.auth.uid ||
        isAdmin()
      );
      allow update: if isSignedIn() && (
        resource.data.recipientId == request.auth.uid ||
        isAdmin()
      );
      allow delete: if isSignedIn() && resource.data.senderId == request.auth.uid;
    }

    // Tontine-specific Invitations
    match /tontine_invitations/{inviteId} {
      allow create: if isSignedIn();
      allow read: if isSignedIn() && (
        resource.data.senderId == request.auth.uid ||
        resource.data.recipientId == request.auth.uid ||
        isAdmin()
      );
      allow update, delete: if isSignedIn() && (
        resource.data.senderId == request.auth.uid ||
        resource.data.recipientId == request.auth.uid
      );
    }

    // ================= MODERATION =================

    // Moderation Cases
    match /moderation_cases/{caseId} {
      allow create: if isSignedIn(); // Any user can report
      allow read: if isAdmin() || (isSignedIn() && resource.data.reporterId == request.auth.uid);
      allow update: if isAdmin();
    }

    // Reports (User reports)
    match /reports/{reportId} {
      allow create: if isSignedIn() && request.resource.data.reporterId == request.auth.uid;
      allow read: if isSignedIn() && (resource.data.reporterId == request.auth.uid || isAdmin());
      allow update: if isAdmin();
    }

    // ================= ORDERS & COMMERCE =================

    // Orders
    match /orders/{orderId} {
      allow create: if isSignedIn() && request.resource.data.buyerId == request.auth.uid;
      allow read: if isSignedIn() && (
        resource.data.buyerId == request.auth.uid ||
        resource.data.sellerId == request.auth.uid ||
        isAdmin()
      );
      allow update: if isSignedIn() && (
        resource.data.sellerId == request.auth.uid ||
        isAdmin()
      );
    }

    // Merchant Products (alternative path)
    match /merchant_products/{productId} {
      allow read: if true;
      allow write: if isSignedIn() && resource.data.merchantId == request.auth.uid;
    }

    // ================= ENTERPRISE FEATURES =================

    // Employees
    match /employees/{employeeId} {
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        resource.data.companyId in request.auth.token.companies ||
        isAdmin()
      );
      allow create: if isAdmin() || isSignedIn();
      allow update: if isAdmin();
    }

    // Enterprise Alerts
    match /enterprise_alerts/{alertId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // ================= LEGAL & COMPLIANCE =================

    // User Consents (subcollection handled above, root collection)
    match /consents/{consentId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
    }

    // Legal Documents
    match /legal_documents/{docId} {
      allow read: if true; // Public legal documents
      allow write: if isAdmin();
    }

    // Legal Texts (CGU versions, etc.)
    match /legal_texts/{textId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Tontine Rule History
    match /tontine_rule_history/{historyId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // ================= APP CONFIGURATION =================

    // App Config (feature flags, etc.)
    match /app_config/{configId} {
      allow read: if true; // Public config
      allow write: if isAdmin();
    }

    // ================= WALLET & FINANCIAL CACHE =================

    // Wallet Cache (read-only mirror for UI performance)
    match /wallet_cache/{userId} {
      allow read: if isSignedIn() && request.auth.uid == userId;
      allow write: if false; // Server-side only
    }

    // PSP Balances (Payment Service Provider data)
    match /psp_balances/{balanceId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow write: if false; // Server-side only
    }

    // ================= SESSION & SECURITY =================

    // User Sessions
    match /sessions/{sessionId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    // Login History (subcollection under users, but also root)
    match /login_history/{logId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create: if isSignedIn();
    }

    // ================= REFERRAL & CAMPAIGNS =================

    // Communication Campaigns
    match /campaigns/{campaignId} {
      allow read, write: if isAdmin();
    }

    // Referral Campaigns
    match /referral_campaigns/{campaignId} {
      allow read: if true; // Public campaigns
      allow write: if isAdmin();
    }

    // Launch Promotions
    match /launch_promotions/{promoId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ================= NOTIFICATIONS (Root) =================

    // Root notifications collection
    match /notifications/{notificationId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    // ================= MEMBERS (Circle Members) =================

    match /members/{memberId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
    }

    // ================= DEFAULT FALLBACK =================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
