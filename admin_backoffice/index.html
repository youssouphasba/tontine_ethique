<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tontetic Admin - Back-office S√©curis√©</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #1a1a2e;
            --secondary: #16213e;
            --accent: #7c3aed;
            --danger: #dc2626;
            --success: #16a34a;
            --warning: #f59e0b;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background: var(--primary);
            color: var(--text);
            min-height: 100vh;
        }

        /* Login Screen */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }

        .login-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 40px;
            border-radius: 16px;
            width: 400px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .login-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-header i {
            font-size: 48px;
            color: var(--accent);
            margin-bottom: 16px;
        }

        .login-header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .login-header p {
            color: var(--text-muted);
            font-size: 14px;
        }

        .security-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            background: rgba(220, 38, 38, 0.2);
            border: 1px solid var(--danger);
            border-radius: 8px;
            margin-bottom: 24px;
            font-size: 12px;
            color: #fca5a5;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-muted);
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
            font-size: 16px;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn-login {
            width: 100%;
            padding: 14px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-login:hover {
            background: #6d28d9;
        }

        .mfa-notice {
            margin-top: 16px;
            padding: 12px;
            background: rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            font-size: 12px;
            text-align: center;
            color: #93c5fd;
        }

        /* Dashboard Layout */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: flex;
        }

        .sidebar {
            width: 260px;
            background: var(--secondary);
            min-height: 100vh;
            padding: 20px 0;
            position: fixed;
            left: 0;
            top: 0;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .sidebar-header h2 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
        }

        .sidebar-header h2 i {
            color: var(--accent);
        }

        .nav-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(124, 58, 237, 0.1);
            color: var(--text);
            border-left-color: var(--accent);
        }

        .nav-item i {
            width: 20px;
        }

        .nav-item .badge {
            margin-left: auto;
            padding: 2px 8px;
            background: var(--danger);
            border-radius: 10px;
            font-size: 11px;
        }

        .sidebar-footer {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            padding: 0 20px;
        }

        .no-funds-warning {
            padding: 12px;
            background: rgba(220, 38, 38, 0.2);
            border: 1px solid var(--danger);
            border-radius: 8px;
            font-size: 11px;
            color: #fca5a5;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .main-content {
            margin-left: 260px;
            padding: 24px;
            flex: 1;
            min-height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 28px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
        }

        .user-badge img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent);
        }

        /* Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--secondary);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .stat-card.readonly {
            opacity: 0.7;
            position: relative;
        }

        .stat-card.readonly::after {
            content: 'üîí RO';
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .stat-card .icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .stat-card .label {
            color: var(--text-muted);
            font-size: 14px;
        }

        .stat-card .trend {
            font-size: 12px;
            margin-top: 8px;
        }

        .trend.up {
            color: var(--success);
        }

        .trend.down {
            color: var(--danger);
        }

        /* Tables */
        .card {
            background: var(--secondary);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 24px;
        }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h3 {
            font-size: 16px;
        }

        table {
            width: 100%;
        }

        th,
        td {
            padding: 12px 20px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        th {
            color: var(--text-muted);
            font-weight: 500;
            font-size: 12px;
            text-transform: uppercase;
        }

        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .status.active {
            background: rgba(22, 163, 74, 0.2);
            color: #86efac;
        }

        .status.pending {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
        }

        .status.suspended {
            background: rgba(220, 38, 38, 0.2);
            color: #fca5a5;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 4px;
        }

        .action-btn.view {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
        }

        .action-btn.suspend {
            background: rgba(220, 38, 38, 0.2);
            color: #fca5a5;
        }

        .action-btn.approve {
            background: rgba(22, 163, 74, 0.2);
            color: #86efac;
        }

        /* Health Banner */
        .health-banner {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            padding: 20px 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .health-info h2 {
            font-size: 22px;
            margin-bottom: 4px;
        }

        .health-info p {
            opacity: 0.8;
        }

        .health-stat {
            text-align: right;
        }

        .health-stat .label {
            font-size: 12px;
            opacity: 0.8;
        }

        .health-stat .value {
            font-size: 32px;
            font-weight: bold;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
        }

        .tab.active {
            background: var(--accent);
            color: white;
        }

        /* Hidden by default */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, getDoc, doc, updateDoc, setDoc, query, where, onSnapshot, limit, orderBy, getCountFromServer, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBCQ3QpFFY-6KdVr_t_DFC7tc3q9iWMSlI",
            authDomain: "tontetic-admin.firebaseapp.com",
            projectId: "tontetic-admin",
            storageBucket: "tontetic-admin.firebasestorage.app",
            messagingSenderId: "535394748480",
            appId: "1:535394748480:web:2e735be402fd8715e477a5"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app, 'europe-west1');

        console.log('[FIREBASE] Admin connected to project:', app.options.projectId);

        // Export for use in other scripts
        window.auth = auth;
        window.db = db;
        window.functions = functions;
        window.firebaseUtils = {
            getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence,
            getFirestore, collection, getDocs, getDoc, doc, updateDoc, setDoc, query, where, onSnapshot, limit, orderBy, getCountFromServer,
            serverTimestamp, addDoc,
            httpsCallable
        };
    </script>
</head>

<body>
    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <div class="login-header">
                <i class="fas fa-shield-halved"></i>
                <h1>Tontetic Admin</h1>
                <p>Back-office s√©curis√©</p>
            </div>

            <div class="security-badge">
                <i class="fas fa-lock"></i>
                Acc√®s r√©serv√© aux administrateurs autoris√©s
            </div>

            <form id="loginForm">
                <div class="form-group">
                    <label>Email administrateur</label>
                    <input type="email" id="email" placeholder="admin@tontetic.com" required>
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" class="btn-login">
                    <i class="fas fa-right-to-bracket"></i> Connexion s√©curis√©e
                </button>
            </form>

            <div class="mfa-notice">
                <i class="fas fa-mobile-screen"></i>
                Authentification √† deux facteurs activ√©e
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-shield-halved"></i> Tontetic Admin</h2>
            </div>

            <nav>
                <div class="nav-item active" data-section="overview">
                    <i class="fas fa-chart-line"></i>
                    <span>Vue d'ensemble</span>
                </div>
                <div class="nav-item" data-section="plans">
                    <i class="fas fa-tags"></i>
                    <span>Gestion des Plans</span>
                    <span class="badge" style="background: var(--accent);">Nouveau</span>
                </div>
                <div class="nav-item" data-section="users">
                    <i class="fas fa-users"></i>
                    <span>Utilisateurs</span>
                </div>
                <div class="nav-item" data-section="circles">
                    <i class="fas fa-circle-notch"></i>
                    <span>Cercles</span>
                </div>
                <div class="nav-item" data-section="moderation">
                    <i class="fas fa-shield"></i>
                    <span>Mod√©ration</span>
                    <span class="badge" id="badge-moderation">--</span>
                </div>
                <div class="nav-item" data-section="merchants">
                    <i class="fas fa-store"></i>
                    <span>Marchands</span>
                </div>
                <div class="nav-item" data-section="enterprises">
                    <i class="fas fa-building"></i>
                    <span>Entreprises</span>
                </div>
                <div class="nav-item" data-section="finance">
                    <i class="fas fa-chart-pie"></i>
                    <span>Finance</span>
                    <span class="badge" style="background: #22c55e;">‚úì</span>
                </div>
                <div class="nav-item" data-section="reports">
                    <i class="fas fa-flag"></i>
                    <span>Signalements</span>
                    <span class="badge" id="badge-reports">--</span>
                </div>
                <div class="nav-item" data-section="support">
                    <i class="fas fa-headset"></i>
                    <span>Support</span>
                    <span class="badge" style="background: #3b82f6;" id="badge-support">--</span>
                </div>
                <div class="nav-item" data-section="campaigns">
                    <i class="fas fa-bullhorn"></i>
                    <span>Campagnes</span>
                </div>
                <div class="nav-item" data-section="referral">
                    <i class="fas fa-user-friends"></i>
                    <span>Parrainage</span>
                    <span class="badge" style="background: #22c55e;" id="badge-referral">--</span>
                </div>
                <div class="nav-item" data-section="security">
                    <i class="fas fa-shield-alt"></i>
                    <span>S√©curit√©</span>
                    <span class="badge" style="background: #22c55e;">OK</span>
                </div>
                <div class="nav-item" data-section="audit">
                    <i class="fas fa-history"></i>
                    <span>Audit</span>
                </div>
                <div class="nav-item" data-section="settings">
                    <i class="fas fa-cog"></i>
                    <span>Param√®tres</span>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="no-funds-warning">
                    <i class="fas fa-ban"></i>
                    <span>Aucun acc√®s aux fonds</span>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Overview Section -->
            <section class="section active" id="overview">
                <div class="header">
                    <h1>Vue d'ensemble</h1>
                    <div class="header-actions">
                        <span style="color: var(--text-muted);">Derni√®re MAJ: <span id="lastUpdate"></span></span>
                        <div class="user-badge">
                            <i class="fas fa-user-shield" style="color: var(--accent);"></i>
                            <span>Admin</span>
                        </div>
                    </div>
                </div>

                <div class="health-banner">
                    <div class="health-info">
                        <h2><i class="fas fa-check-circle"></i> <span id="health-status-text">Plateforme
                                op√©rationnelle</span></h2>
                        <p><span id="health-description">Chargement des donn√©es...</span></p>
                    </div>
                    <div class="health-stat">
                        <div class="label">Uptime</div>
                        <div class="value" id="health-uptime">--%</div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="icon" style="background: rgba(59,130,246,0.2);">
                            <i class="fas fa-users" style="color: #60a5fa;"></i>
                        </div>
                        <div class="value" id="stat_users">-</div>
                        <div class="label">Utilisateurs</div>
                        <div class="trend" id="trend_users">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon" style="background: rgba(34,197,94,0.2);">
                            <i class="fas fa-circle-notch" style="color: #4ade80;"></i>
                        </div>
                        <div class="value" id="stat_circles">-</div>
                        <div class="label">Cercles actifs</div>
                        <div class="trend" id="trend_circles">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon" style="background: rgba(168,85,247,0.2);">
                            <i class="fas fa-store" style="color: #c084fc;"></i>
                        </div>
                        <div class="value" id="stat_merchants">-</div>
                        <div class="label">Marchands</div>
                        <div class="trend" id="trend_merchants">-</div>
                    </div>
                    <div class="stat-card readonly">
                        <div class="icon" style="background: rgba(20,184,166,0.2);">
                            <i class="fas fa-coins" style="color: #5eead4;"></i>
                        </div>
                        <div class="value" id="stat_volume">-</div>
                        <div class="label">Flux PSP (FCFA)</div>
                        <div class="trend">Lecture seule</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-bell" style="color: var(--warning);"></i> Alertes actives</h3>
                        <button class="action-btn view">Voir tout</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Message</th>
                                <th>S√©v√©rit√©</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="alertsTableBody">
                            <tr>
                                <td colspan="4"
                                    style="text-align:center; color:var(--text-muted); font-size:12px; padding:20px;">
                                    Aucune alerte active</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Plans Section -->
            <section class="section" id="plans">
                <div class="header">
                    <h1>Gestion des Offres & Plans</h1>
                    <div class="header-actions">
                        <button class="action-btn view" onclick="populateDefaultPlans()" id="btnPopulate"><i
                                class="fas fa-magic"></i> Initialiser Plans D√©faut</button>
                        <button class="action-btn approve" onclick="openPlanModal(null)"><i class="fas fa-plus"></i>
                            Nouveau Plan</button>
                        <button class="action-btn" onclick="refreshPlans()"><i class="fas fa-sync"></i>
                            Actualiser</button>
                    </div>
                </div>

                <div class="security-badge"
                    style="margin-bottom: 20px; background: rgba(124, 58, 237, 0.1); border-color: var(--accent);">
                    <i class="fas fa-magic"></i> Les modifications ici sont appliqu√©es en temps r√©el sur l'application
                    mobile.
                </div>

                <div class="stats-grid" id="plansStats">
                    <div class="stat-card">
                        <div class="icon" style="background: rgba(124, 58, 237, 0.2);"><i class="fas fa-user"
                                style="color: var(--accent);"></i></div>
                        <div class="value" id="countUserPlans">-</div>
                        <div class="label">Plans Utilisateurs</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon" style="background: rgba(59, 130, 246, 0.2);"><i class="fas fa-building"
                                style="color: #60a5fa;"></i></div>
                        <div class="value" id="countEnterprisePlans">-</div>
                        <div class="label">Plans Entreprises</div>
                    </div>
                    <div class="stat-card">
                        <div class="icon" style="background: rgba(20, 184, 166, 0.2);"><i class="fas fa-store"
                                style="color: #2dd4bf;"></i></div>
                        <div class="value" id="countMerchantPlans">-</div>
                        <div class="label">Plans Marchands</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Liste des Plans Firestore</h3>
                    </div>
                    <div style="overflow-x: auto;">
                        <table id="plansTable">
                            <thead>
                                <tr>
                                    <th>ID / Nom</th>
                                    <th>Type</th>
                                    <th>Prix (‚Ç¨ / FCFA)</th>
                                    <th>Limites (Cercles/Membres)</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="plansTableBody">
                                <!-- Dynamically populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Edit Plan Modal (Custom Overlay) -->
            <div id="editPlanModal"
                style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
                <div class="card"
                    style="width: 600px; max-height: 90vh; overflow-y: auto; background: var(--secondary);">
                    <div class="card-header">
                        <h3 id="modalTitle">Modifier le Plan</h3>
                        <button onclick="closePlanModal()"
                            style="background: none; border: none; color: white; cursor: pointer;"><i
                                class="fas fa-times"></i></button>
                    </div>
                    <div style="padding: 20px;">
                        <form id="editPlanForm">
                            <input type="hidden" id="editPlanId">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div class="form-group">
                                    <label>Nom Affich√©</label>
                                    <input type="text" id="editPlanName" required>
                                </div>
                                <div class="form-group">
                                    <label>Emoji / Ic√¥ne</label>
                                    <input type="text" id="editPlanEmoji">
                                </div>
                                <div class="form-group">
                                    <label>Prix EUR (‚Ç¨)</label>
                                    <input type="number" step="0.01" id="editPriceEur">
                                </div>
                                <div class="form-group">
                                    <label>Prix XOF (FCFA)</label>
                                    <input type="number" id="editPriceXof">
                                </div>
                                <div class="form-group">
                                    <label>Code (ex: USER_STARTER)</label>
                                    <input type="text" id="editPlanCode" required>
                                </div>
                                <div class="form-group">
                                    <label>Max Cercles</label>
                                    <input type="number" id="editMaxCircles">
                                </div>
                                <div class="form-group">
                                    <label>Max Membres / cercle</label>
                                    <input type="number" id="editMaxMembers">
                                </div>
                                <div class="form-group">
                                    <label>Montant Pot Max (‚Ç¨)</label>
                                    <input type="number" id="editMaxPot">
                                </div>
                                <div class="form-group">
                                    <label>Stripe Price ID</label>
                                    <input type="text" id="editStripePriceId">
                                </div>
                                <div class="form-group staff-limit" style="display:none;">
                                    <label>Max Collaborateurs (Entreprise)</label>
                                    <input type="number" id="editMaxEmployees" value="0">
                                </div>
                                <div class="form-group product-limit" style="display:none;">
                                    <label>Max Produits (Marchand)</label>
                                    <input type="number" id="editMaxProducts" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Ordre d'affichage (0, 1, 2...)</label>
                                    <input type="number" id="editSortOrder" value="0">
                                </div>
                                <div class="form-group">
                                    <label>Cible (Audience)</label>
                                    <select id="editPlanAudience" onchange="toggleSpecialLimits()"
                                        style="width: 100%; padding: 12px; border-radius: 8px; background: rgba(255,255,255,0.05); color: white; border: 1px solid rgba(255,255,255,0.1);">
                                        <option value="user">Utilisateur</option>
                                        <option value="enterprise">Entreprise</option>
                                        <option value="merchant">Marchand</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>P√©riode Facturation</label>
                                    <select id="editBillingPeriod"
                                        style="width: 100%; padding: 12px; border-radius: 8px; background: rgba(255,255,255,0.05); color: white; border: 1px solid rgba(255,255,255,0.1);">
                                        <option value="month">Mensuel</option>
                                        <option value="year">Annuel</option>
                                        <option value="once">Une fois</option>
                                        <option value="none">Aucune</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group" style="margin-top: 16px;">
                                <label>Statut</label>
                                <select id="editPlanStatus"
                                    style="width: 100%; padding: 12px; border-radius: 8px; background: rgba(255,255,255,0.05); color: white; border: 1px solid rgba(255,255,255,0.1);">
                                    <option value="active">Actif</option>
                                    <option value="draft">Brouillon</option>
                                    <option value="archived">Archiv√©</option>
                                </select>
                            </div>
                            <div class="form-group"
                                style="margin-top: 16px; display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="editIsActive" style="width: 20px; height: 20px;">
                                <label for="editIsActive" style="margin: 0;">Plan visible et actif</label>
                            </div>
                            <div style="margin-top: 24px; display: flex; gap: 12px;">
                                <button type="submit" class="btn-login" style="flex: 2;">ENREGISTRER LES
                                    MODIFICATIONS</button>
                                <button type="button" class="action-btn suspend" style="flex: 1;"
                                    onclick="closePlanModal()">ANNULER</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Support Ticket Response Modal -->
            <div id="supportTicketModal"
                style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
                <div class="card"
                    style="width: 700px; max-height: 90vh; background: var(--secondary); display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1);">
                    <div class="card-header" style="flex-shrink: 0;">
                        <h3>Ticket: <span id="supportModalTitle">#---</span></h3>
                        <button onclick="closeSupportModal()"
                            style="background: none; border: none; color: white; cursor: pointer; font-size: 20px;"><i
                                class="fas fa-times"></i></button>
                    </div>

                    <div id="supportTicketDetails"
                        style="padding: 12px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; color: var(--text-muted); flex-shrink: 0; background: rgba(255,255,255,0.02);">
                        <!-- Detail line here -->
                    </div>

                    <div id="supportChatHistory"
                        style="flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; background: rgba(0,0,0,0.2); min-height: 250px;">
                        <!-- Messages populated here -->
                    </div>

                    <div
                        style="padding: 15px 20px; background: rgba(255,255,255,0.03); border-top: 1px solid rgba(255,255,255,0.05);">
                        <div
                            style="font-size: 11px; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                            R√©ponses rapides</div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="action-btn view" style="font-size: 11px; padding: 5px 10px;"
                                onclick="useSupportTemplate('Bonjour ! üëã Bienvenue sur Tontetic. Comment pouvons-nous vous aider aujourd\'hui ?')">üìù
                                Bienvenue</button>
                            <button class="action-btn view" style="font-size: 11px; padding: 5px 10px;"
                                onclick="useSupportTemplate('Nous v√©rifions actuellement votre paiement. Cela peut prendre quelques minutes selon votre banque.')">üí≥
                                Paiement</button>
                            <button class="action-btn view" style="font-size: 11px; padding: 5px 10px;"
                                onclick="useSupportTemplate('Pour quitter un cercle, allez dans les param√®tres du cercle et cliquez sur \'Quitter\'.')">‚≠ï
                                Quitter Cercle</button>
                            <button class="action-btn view" style="font-size: 11px; padding: 5px 10px;"
                                onclick="useSupportTemplate('Pour devenir marchand, soumettez vos documents Kbis dans la section d√©di√©e de votre profil.')">üè™
                                Marchand</button>
                        </div>
                    </div>

                    <div
                        style="padding: 20px; background: var(--secondary); border-top: 1px solid rgba(255,255,255,0.05); flex-shrink: 0;">
                        <input type="hidden" id="currentTicketId">
                        <div style="display: flex; gap: 12px;">
                            <textarea id="supportReplyText" placeholder="√âcrire une r√©ponse..."
                                style="flex-grow: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white; padding: 12px; resize: none; height: 80px; font-family: inherit; font-size: 14px;"></textarea>
                            <button class="btn-login" onclick="sendSupportReply()"
                                style="width: 120px; height: 80px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <i class="fas fa-paper-plane"></i> ENVOYER
                            </button>
                        </div>
                        <div
                            style="margin-top: 16px; display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="status" id="supportTicketStatusBadge"
                                    style="background: rgba(34,197,94,0.1); color: var(--success);">OUVERT</span>
                                <span id="supportTicketCategory"
                                    style="font-size: 12px; color: var(--text-muted);"></span>
                            </div>
                            <button id="resolveTicketBtn" class="action-btn view" onclick="resolveTicket()"
                                style="background: var(--success); color: white; padding: 8px 16px; border: none; border-radius: 6px; font-weight: bold;">
                                <i class="fas fa-check-circle"></i> MARQUER COMME R√âSOLU
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Universal Document Detail Modal -->
            <div id="documentDetailModal"
                style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1100; align-items: center; justify-content: center;">
                <div class="card"
                    style="width: 600px; max-height: 85vh; background: var(--secondary); display: flex; flex-direction: column;">
                    <div class="card-header">
                        <h3>D√©tails du document</h3>
                        <button onclick="closeDetailModal()"
                            style="background:none; border:none; color:white; cursor:pointer;"><i
                                class="fas fa-times"></i></button>
                    </div>
                    <div id="documentDetailContent"
                        style="padding: 20px; overflow-y: auto; font-family: monospace; font-size: 13px; color: #a5f3fc; background: #0f172a;">
                        <!-- JSON data here -->
                    </div>
                    <div style="padding: 15px; border-top: 1px solid rgba(255,255,255,0.05); text-align: right;">
                        <button class="action-btn view" onclick="closeDetailModal()">FERMER</button>
                    </div>
                </div>
            </div>

            <!-- Campaign Creation Modal -->
            <div id="campaignModal"
                style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1100; align-items: center; justify-content: center;">
                <div class="card"
                    style="width: 600px; max-height: 85vh; background: var(--secondary); display: flex; flex-direction: column;">
                    <div class="card-header">
                        <h3><i class="fas fa-bullhorn" style="color: var(--accent);"></i> Nouvelle Campagne Marketing
                        </h3>
                        <button onclick="closeCampaignModal()"
                            style="background:none; border:none; color:white; cursor:pointer;"><i
                                class="fas fa-times"></i></button>
                    </div>
                    <form id="campaignForm" style="padding: 20px; overflow-y: auto;">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: bold;">Titre de la campagne
                                *</label>
                            <input type="text" id="campaign_title" required
                                style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: bold;">Message *</label>
                            <textarea id="campaign_body" required rows="4"
                                style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; resize: vertical;"></textarea>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; margin-bottom: 6px; font-weight: bold;">Type</label>
                                <select id="campaign_type"
                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(30,30,30,1); color: white;">
                                    <option value="push">üì≤ Notification Push</option>
                                    <option value="email">üìß Email</option>
                                    <option value="inapp">üì¢ In-App Banner</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 6px; font-weight: bold;">Cible</label>
                                <select id="campaign_target"
                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(30,30,30,1); color: white;">
                                    <option value="all">üë• Tous les utilisateurs</option>
                                    <option value="active">üü¢ Utilisateurs actifs</option>
                                    <option value="inactive">üî¥ Utilisateurs inactifs (> 30j)</option>
                                    <option value="premium">‚≠ê Abonn√©s Premium</option>
                                    <option value="merchants">üè™ Marchands</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="campaign_schedule" style="width: 18px; height: 18px;">
                                <span>Programmer l'envoi</span>
                            </label>
                            <input type="datetime-local" id="campaign_scheduled_date"
                                style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white; margin-top: 8px; display: none;">
                        </div>
                    </form>
                    <div
                        style="padding: 15px 20px; border-top: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between;">
                        <button class="action-btn view" onclick="closeCampaignModal()">Annuler</button>
                        <div style="display: flex; gap: 8px;">
                            <button class="action-btn view" onclick="saveCampaignDraft()"><i class="fas fa-save"></i>
                                Sauv. brouillon</button>
                            <button class="action-btn approve" onclick="sendCampaign()"><i
                                    class="fas fa-paper-plane"></i> Envoyer maintenant</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Referral Campaign Modal -->
            <div id="referralCampaignModal"
                style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1100; align-items: center; justify-content: center;">
                <div class="card"
                    style="width: 600px; max-height: 85vh; background: var(--secondary); display: flex; flex-direction: column;">
                    <div class="card-header">
                        <h3><i class="fas fa-gift" style="color: var(--success);"></i> Nouvelle Campagne de Parrainage
                        </h3>
                        <button onclick="closeReferralCampaignModal()"
                            style="background:none; border:none; color:white; cursor:pointer;"><i
                                class="fas fa-times"></i></button>
                    </div>
                    <form id="referralCampaignForm" style="padding: 20px; overflow-y: auto;">
                        <!-- Campaign Name -->
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: bold;">Nom de la campagne
                                *</label>
                            <input type="text" id="ref_campaign_name" required placeholder="Ex: Parrainage √ât√© 2026"
                                style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white;">
                        </div>

                        <!-- Subscription Type & Reward Type -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; margin-bottom: 6px; font-weight: bold;">Type d'abonnement
                                    offert</label>
                                <select id="ref_subscription_type"
                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(30,30,30,1); color: white;">
                                    <option value="starter" selected>üöÄ Starter (9,99‚Ç¨/mois)</option>
                                    <option value="pro">‚≠ê Pro (19,99‚Ç¨/mois)</option>
                                    <option value="enterprise">üè¢ Enterprise (49,99‚Ç¨/mois)</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 6px; font-weight: bold;">Dur√©e
                                    offerte</label>
                                <select id="ref_reward_months"
                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(30,30,30,1); color: white;">
                                    <option value="1">1 mois</option>
                                    <option value="2">2 mois</option>
                                    <option value="3" selected>3 mois</option>
                                    <option value="6">6 mois</option>
                                    <option value="12">12 mois (1 an)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Reward Recipients -->
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: bold;">Qui re√ßoit la
                                r√©compense ?</label>
                            <select id="ref_reward_type"
                                style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(30,30,30,1); color: white;">
                                <option value="both" selected>üéÅ Parrain + Filleul (chacun re√ßoit)</option>
                                <option value="sponsor">üë§ Parrain uniquement</option>
                                <option value="referee">üÜï Filleul uniquement</option>
                            </select>
                        </div>

                        <!-- Campaign Duration -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; margin-bottom: 6px; font-weight: bold;">Date de
                                    d√©but</label>
                                <input type="date" id="ref_start_date"
                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 6px; font-weight: bold;">Date de
                                    fin</label>
                                <input type="date" id="ref_end_date"
                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white;">
                            </div>
                        </div>

                        <!-- Limits -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; margin-bottom: 6px; font-weight: bold;">Nombre max de
                                    parrains</label>
                                <input type="number" id="ref_max_sponsors" value="100" min="1" step="10"
                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white;">
                                <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">Combien
                                    d'utilisateurs peuvent parrainer</div>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 6px; font-weight: bold;">Filleuls max par
                                    parrain</label>
                                <input type="number" id="ref_max_referees_per_sponsor" value="5" min="1" step="1"
                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); color: white;">
                                <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">Limite de
                                    filleuls par parrain</div>
                            </div>
                        </div>

                        <!-- Validation Condition -->
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 6px; font-weight: bold;">Condition de
                                validation</label>
                            <select id="ref_condition"
                                style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(30,30,30,1); color: white;">
                                <option value="join_circle" selected>‚≠ï Rejoint une tontine</option>
                                <option value="create_circle">üÜï Cr√©e une tontine compl√®te</option>
                                <option value="first_contribution">üí∞ Premi√®re cotisation vers√©e</option>
                            </select>
                            <div style="font-size: 11px; color: var(--success); margin-top: 4px;">‚úÖ La r√©compense n'est
                                accord√©e que si le filleul agit r√©ellement</div>
                        </div>

                        <!-- App Visibility Toggle -->
                        <div
                            style="margin-bottom: 16px; padding: 16px; background: rgba(59,130,246,0.1); border-radius: 8px; border: 1px solid rgba(59,130,246,0.3);">
                            <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                <input type="checkbox" id="ref_visible_in_app" checked
                                    style="width: 20px; height: 20px; accent-color: var(--accent);">
                                <div>
                                    <div style="font-weight: bold;">Activer dans l'application</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">Le programme de parrainage
                                        sera visible pour les utilisateurs</div>
                                </div>
                            </label>
                        </div>
                    </form>
                    <div
                        style="padding: 15px 20px; border-top: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between;">
                        <button class="action-btn view" onclick="closeReferralCampaignModal()">Annuler</button>
                        <button class="action-btn approve" onclick="createReferralCampaign()"><i
                                class="fas fa-rocket"></i> Cr√©er la campagne</button>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <section class="section" id="users">
                <div class="header">
                    <h1>Gestion des utilisateurs</h1>
                    <div style="display: flex; gap: 8px;">
                        <button class="action-btn view" onclick="exportData('users', 'csv')"><i
                                class="fas fa-file-csv"></i> Export CSV</button>
                        <button class="action-btn view" onclick="exportData('users', 'json')"><i
                                class="fas fa-file-code"></i> Export JSON</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3>Liste des utilisateurs</h3>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="userSearchInput" placeholder="UID, Email ou Nom..."
                                style="padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: white; width: 250px;">
                            <button class="action-btn view" onclick="searchUsers()"><i
                                    class="fas fa-search"></i></button>
                            <button class="action-btn view" onclick="fetchUsers()"><i class="fas fa-sync"></i></button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Utilisateur</th>
                                <th>Statut</th>
                                <th>R√¥le</th>
                                <th>Score</th>
                                <th>Cercles</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; color: var(--text-muted); padding: 20px;">
                                    <i class="fas fa-spinner fa-spin"></i> Chargement des utilisateurs...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Moderation Section -->
            <section class="section" id="moderation">
                <div class="header">
                    <h1>Mod√©ration des contenus</h1>
                </div>
                <div class="security-badge" style="margin-bottom: 20px;">
                    <i class="fas fa-gavel"></i>
                    LCEN art. 6 : Plateforme h√©bergeur technique - Mod√©ration obligatoire
                </div>
                <div class="tabs">
                    <button class="tab active" id="tab-moderation-pending" onclick="switchModerationTab('pending')">√Ä
                        valider (--)</button>
                    <button class="tab" id="tab-moderation-flagged" onclick="switchModerationTab('flagged')">Signal√©s
                        (--)</button>
                    <button class="tab" id="tab-moderation-suspended"
                        onclick="switchModerationTab('suspended')">Suspendus</button>
                    <button class="tab" id="tab-moderation-history"
                        onclick="switchModerationTab('history')">Historique</button>
                </div>
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>Produit</th>
                                <th>Marchand</th>
                                <th>Raison</th>
                                <th>Depuis</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="moderationTableBody">
                            <tr>
                                <td colspan="5" style="text-align: center; color: var(--text-muted); padding: 20px;">
                                    <i class="fas fa-spinner fa-spin"></i> Chargement de la mod√©ration...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Payments Section (Read Only) -->
            <section class="section" id="payments">
                <div class="header">
                    <h1>Paiements & PSP</h1>
                    <span class="status pending" style="padding: 8px 16px;">üîí LECTURE SEULE</span>
                </div>
                <div class="security-badge" style="margin-bottom: 20px; background: rgba(220,38,38,0.3);">
                    <i class="fas fa-ban"></i>
                    ‚ö†Ô∏è AUCUN ACC√àS AUX FONDS - Actions de paiement uniquement via les PSP
                </div>
                <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="stat-card" style="border: 2px solid var(--success);">
                        <div class="value"><i class="fab fa-stripe" style="color: #635bff;"></i> Stripe</div>
                        <div class="label">Actif ‚Ä¢ -- webhooks OK</div>
                    </div>
                    <div class="stat-card" style="border: 2px solid var(--success);">
                        <div class="value"><i class="fas fa-wave-square" style="color: #1da1f2;"></i> Wave</div>
                        <div class="label">Actif ‚Ä¢ -- webhooks OK</div>
                    </div>
                </div>
            </section>

            <!-- Circles Section -->
            <section class="section" id="circles">
                <div class="header">
                    <h1>Gestion des Cercles / Tontines</h1>
                    <div style="display: flex; gap: 8px;">
                        <button class="action-btn view" onclick="exportData('circles', 'csv')"><i
                                class="fas fa-file-csv"></i> Export CSV</button>
                        <button class="action-btn view" onclick="exportData('circles', 'json')"><i
                                class="fas fa-file-code"></i> Export JSON</button>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="value" style="color: var(--success);" id="circle-stat-active">--</div>
                        <div class="label">Actifs</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" style="color: var(--warning);" id="circle-stat-incomplete">--</div>
                        <div class="label">Incomplets</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" style="color: var(--danger);" id="circle-stat-suspended">--</div>
                        <div class="label">Suspendus</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" style="color: var(--text-muted);" id="circle-stat-closed">--</div>
                        <div class="label">Cl√¥tur√©s</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-circle-notch" style="color: var(--accent);"></i> Liste des cercles</h3>
                        <input type="text" placeholder="Rechercher..."
                            style="padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: white;">
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Cercle</th>
                                <th>Type</th>
                                <th>Membres</th>
                                <th>Montant</th>
                                <th>PSP</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="circlesTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; color: var(--text-muted); padding: 20px;">
                                    <i class="fas fa-spinner fa-spin"></i> Chargement des cercles...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Merchants Section -->
            <section class="section" id="merchants">
                <div class="header">
                    <h1>Gestion des Marchands</h1>
                    <div style="display: flex; gap: 8px;">
                        <button class="action-btn view" onclick="exportData('merchants', 'csv')"><i
                                class="fas fa-file-csv"></i> Export CSV</button>
                        <button class="action-btn view" onclick="exportData('merchants', 'json')"><i
                                class="fas fa-file-code"></i> Export JSON</button>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="value" style="color: var(--warning);" id="merchant-stat-pending">--</div>
                        <div class="label">En attente</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" style="color: var(--success);" id="merchant-stat-active">--</div>
                        <div class="label">Actifs</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" style="color: var(--danger);" id="merchant-stat-suspended">--</div>
                        <div class="label">Suspendus</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" style="color: var(--accent);" id="merchant-stat-products">--</div>
                        <div class="label">Produits</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-store" style="color: var(--accent);"></i> Liste des marchands</h3>
                        <div class="tabs" style="margin: 0;">
                            <button class="tab active">Tous</button>
                            <button class="tab">En attente</button>
                            <button class="tab">Suspendus</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Boutique</th>
                                <th>Propri√©taire</th>
                                <th>Produits</th>
                                <th>IBAN</th>
                                <th>Sanctions</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="merchantsTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; color: var(--text-muted); padding: 20px;">
                                    <i class="fas fa-spinner fa-spin"></i> Chargement des marchands...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Enterprises Section -->
            <section class="section" id="enterprises">
                <div class="header">
                    <h1>Gestion des Entreprises</h1>
                    <div style="display: flex; gap: 8px;">
                        <button class="action-btn view" onclick="exportData('enterprises', 'csv')"><i
                                class="fas fa-file-csv"></i> Export CSV</button>
                        <button class="action-btn view" onclick="exportData('enterprises', 'json')"><i
                                class="fas fa-file-code"></i> Export JSON</button>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="value" id="enterprise-stat-count">--</div>
                        <div class="label">Entreprises</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="enterprise-stat-employees">--</div>
                        <div class="label">Salari√©s</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="enterprise-stat-tontines">--</div>
                        <div class="label">Tontines actives</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="enterprise-stat-revenue">-- FCFA</div>
                        <div class="label">Revenus/mois</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-building" style="color: var(--accent);"></i> Liste des entreprises</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Entreprise</th>
                                <th>Formule</th>
                                <th>Salari√©s</th>
                                <th>Tontines</th>
                                <th>Abondement</th>
                                <th>Dernier paiement</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="enterprisesTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; color: var(--text-muted); padding: 20px;">
                                    <i class="fas fa-spinner fa-spin"></i> Chargement des entreprises...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Finance Section (Compliant Dashboard) -->
            <section class="section" id="finance">
                <div class="header">
                    <h1>üìä Pilotage Financier</h1>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <span
                            style="background: rgba(34,197,94,0.2); color: #86efac; padding: 4px 12px; border-radius: 20px; font-size: 11px;">
                            <i class="fas fa-shield-alt"></i> Conforme PSP
                        </span>
                        <button class="action-btn view" onclick="exportData('financeTableBody', 'csv')"><i
                                class="fas fa-file-csv"></i> Export Mensuel</button>
                        <button class="action-btn view" onclick="exportData('financeTableBody', 'json')"><i
                                class="fas fa-file-code"></i> Ledger</button>
                    </div>
                </div>

                <!-- Compliance Banner -->
                <div
                    style="background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(34,197,94,0.1)); border: 1px solid rgba(59,130,246,0.3); border-radius: 12px; padding: 16px; margin-bottom: 24px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <i class="fas fa-info-circle" style="color: #60a5fa; font-size: 20px;"></i>
                        <div>
                            <div style="font-weight: bold; color: white;">Outil de pilotage et conformit√© - Pas une
                                caisse</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Aucune manipulation de fonds
                                utilisateurs. Donn√©es PSP en lecture seule. Journal immuable.</div>
                        </div>
                    </div>
                </div>

                <!-- 3 FLUX Stats -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; margin-bottom: 24px;">
                    <!-- BLOC A: Flux Plateforme -->
                    <div class="card" style="border-top: 3px solid #22c55e;">
                        <div style="padding: 16px;">
                            <div style="font-size: 12px; color: var(--success); font-weight: bold; margin-bottom: 8px;">
                                üí∞ FLUX PLATEFORME (NOTRE ARGENT)
                            </div>
                            <div style="font-size: 28px; font-weight: bold;" id="stat_revenue_total">0 F</div>
                            <div style="font-size: 11px; color: var(--text-muted);" id="stat_revenue_details">HT: 0 F |
                                TVA: 0 F</div>
                            <div
                                style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 12px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <span>Abos entreprises</span><span style="color: var(--success);"
                                        id="stat_revenue_enterprise">0 F</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Boosts marchands</span><span style="color: var(--success);"
                                        id="stat_revenue_merchant">0 F</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- BLOC B: Flux Utilisateurs (LECTURE SEULE) -->
                    <div class="card" style="border-top: 3px solid #64748b;">
                        <div style="padding: 16px;">
                            <div style="font-size: 12px; color: #94a3b8; font-weight: bold; margin-bottom: 8px;">
                                ‚ö†Ô∏è FLUX UTILISATEURS (PSP - LECTURE SEULE)
                            </div>
                            <div
                                style="font-size: 11px; color: var(--warning); margin-bottom: 8px; padding: 6px; background: rgba(251,191,36,0.1); border-radius: 4px;">
                                Informations fournies √† titre indicatif par le PSP
                            </div>
                            <div
                                style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 12px;">
                                <div
                                    style="text-align: center; padding: 8px; background: rgba(34,197,94,0.1); border-radius: 6px;">
                                    <div style="font-size: 18px; font-weight: bold;" id="stat_volume_captured">0</div>
                                    <div style="color: var(--success);">Pr√©lev√©s</div>
                                </div>
                                <div
                                    style="text-align: center; padding: 8px; background: rgba(59,130,246,0.1); border-radius: 6px;">
                                    <div style="font-size: 18px; font-weight: bold;" id="stat_volume_authorized">0</div>
                                    <div style="color: #60a5fa;">Autoris√©s</div>
                                </div>
                                <div
                                    style="text-align: center; padding: 8px; background: rgba(239,68,68,0.1); border-radius: 6px;">
                                    <div style="font-size: 18px; font-weight: bold;" id="stat_volume_rejected">0</div>
                                    <div style="color: var(--danger);">Rejet√©s</div>
                                </div>
                                <div
                                    style="text-align: center; padding: 8px; background: rgba(251,191,36,0.1); border-radius: 6px;">
                                    <div style="font-size: 18px; font-weight: bold;" id="stat_volume_pending">0</div>
                                    <div style="color: var(--text-muted);">En attente</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- BLOC C: Flux Promotionnels -->
                    <div class="card" style="border-top: 3px solid #a855f7;">
                        <div style="padding: 16px;">
                            <div style="font-size: 12px; color: #c4b5fd; font-weight: bold; margin-bottom: 8px;">
                                üéÅ FLUX PROMOTIONNELS / PRIMES
                            </div>
                            <div style="font-size: 28px; font-weight: bold;" id="stat_promotional_total">0 F</div>
                            <div style="font-size: 11px; color: var(--text-muted);" id="stat_promotional_count">Budget
                                marketing & abondements (0 events)</div>
                            <div
                                style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 12px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <span>Parrainage vers√©</span><span style="color: #c4b5fd;">0 F</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Bonus entreprise (d√©clench√©)</span><span style="color: #c4b5fd;">0
                                        F</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ============================================================ -->
                <!-- KPIs OBLIGATOIRES - 5 CAT√âGORIES -->
                <!-- ============================================================ -->

                <!-- A. KPIs FINANCIERS PLATEFORME -->
                <div class="card" style="margin-top: 24px; border-top: 3px solid #22c55e;">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-line" style="color: var(--success);"></i> A. KPIs Financiers
                            Plateforme</h3>
                    </div>
                    <div style="padding: 20px;">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="value" style="color: var(--success);" id="kpi-mrr">-- F</div>
                                <div class="label">MRR (Revenu Mensuel R√©current)</div>
                            </div>
                            <div class="stat-card">
                                <div class="value" id="kpi-total-ht">-- F</div>
                                <div class="label">Total HT</div>
                            </div>
                            <div class="stat-card">
                                <div class="value" id="kpi-total-tva">-- F</div>
                                <div class="label">Total TVA</div>
                            </div>
                            <div class="stat-card">
                                <div class="value" style="color: var(--danger);" id="kpi-rate-churn">--%</div>
                                <div class="label">Taux √©chec abonnement</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 16px;">
                            <div style="padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Revenu par
                                    Formule</div>
                                <div style="font-size: 13px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                        <span>Entreprise</span><span style="color: var(--success);">-- F</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                        <span>D√©partement</span><span style="color: var(--success);">-- F</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>Starter Pro</span><span style="color: var(--text-muted);">-- F</span>
                                    </div>
                                </div>
                            </div>
                            <div style="padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Revenu par
                                    Pays</div>
                                <div style="font-size: 13px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                        <span>üá∏üá≥ S√©n√©gal</span><span style="color: var(--success);">-- F</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                        <span>üá®üáÆ C√¥te d'Ivoire</span><span style="color: var(--success);">-- F</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>üá´üá∑ France</span><span style="color: var(--success);">-- F</span>
                                    </div>
                                </div>
                            </div>
                            <div style="padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Entreprises
                                    vs Marchands</div>
                                <div style="font-size: 13px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                        <span>Entreprises</span><span style="color: var(--success);">-- F</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                        <span>Marchands (boosts)</span><span style="color: var(--success);">-- F</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: var(--danger);">Churn entreprises</span><span
                                            style="color: var(--danger);">--%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- B. KPIs PSP / RISQUE -->
                <div class="card" style="margin-top: 24px; border-top: 3px solid #f59e0b;">
                    <div class="card-header">
                        <h3><i class="fas fa-exclamation-triangle" style="color: var(--warning);"></i> B. KPIs PSP /
                            Risque</h3>
                    </div>
                    <div style="padding: 20px;">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="value" style="color: var(--danger);">0%</div>
                                <div class="label">Taux √©chec pr√©l√®vement</div>
                            </div>
                            <div class="stat-card">
                                <div class="value" style="color: var(--warning);">0</div>
                                <div class="label">Comptes PSP bloqu√©s</div>
                            </div>
                            <div class="stat-card">
                                <div class="value">-- h</div>
                                <div class="label">D√©lai moyen confirmation PSP</div>
                            </div>
                            <div class="stat-card">
                                <div class="value" style="color: var(--danger);">0</div>
                                <div class="label">Garanties d√©clench√©es</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-top: 16px;">
                            <div
                                style="padding: 16px; background: rgba(239,68,68,0.1); border-radius: 8px; border-left: 3px solid var(--danger);">
                                <div style="font-size: 12px; color: var(--danger); font-weight: bold;">D√©fauts par
                                    Cercle</div>
                                <div style="font-size: 24px; font-weight: bold; margin: 8px 0;">0%</div>
                                <div style="font-size: 11px; color: var(--text-muted)">0 cercle sur 0 avec d√©faut
                                    constat√©</div>
                            </div>
                            <div style="padding: 16px; background: rgba(59,130,246,0.1); border-radius: 8px;">
                                <div style="font-size: 12px; color: #60a5fa;">√âtat des Garanties</div>
                                <div style="display: flex; gap: 16px; margin-top: 8px; font-size: 13px;">
                                    <div><span style="color: var(--warning);">‚óè</span> Bloqu√©es: 0</div>
                                    <div><span style="color: var(--danger);">‚óè</span> Utilis√©es: 0</div>
                                    <div><span style="color: var(--success);">‚óè</span> Lib√©r√©es: 0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- C. KPIs UTILISATION (NON FINANCIERS) -->
                <div class="card" style="margin-top: 24px; border-top: 3px solid #3b82f6;">
                    <div class="card-header">
                        <h3><i class="fas fa-users" style="color: #60a5fa;"></i> C. KPIs Utilisation (Non Financiers)
                        </h3>
                    </div>
                    <div style="padding: 20px;">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="value" style="color: var(--success);">--</div>
                                <div class="label">Cercles actifs</div>
                            </div>
                            <div class="stat-card">
                                <div class="value">--</div>
                                <div class="label">Cercles cl√¥tur√©s sans incident</div>
                            </div>
                            <div class="stat-card">
                                <div class="value" style="color: var(--danger);">--</div>
                                <div class="label">Cercles avec d√©faut</div>
                            </div>
                            <div class="stat-card">
                                <div class="value">--</div>
                                <div class="label">Membres moyens par cercle</div>
                            </div>
                        </div>
                        <div
                            style="margin-top: 16px; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span style="font-size: 12px; color: var(--text-muted);">Taux de remplacement
                                        membre</span>
                                    <span style="font-size: 18px; font-weight: bold; margin-left: 12px;">--%</span>
                                </div>
                                <div style="font-size: 12px; color: var(--text-muted);">Total cercles: --</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- D. KPIs MARCHANDS -->
                <div class="card" style="margin-top: 24px; border-top: 3px solid #a855f7;">
                    <div class="card-header">
                        <h3><i class="fas fa-store" style="color: #c4b5fd;"></i> D. KPIs Marchands</h3>
                    </div>
                    <div style="padding: 20px;">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="value" style="color: var(--success);">--</div>
                                <div class="label">Marchands actifs</div>
                            </div>
                            <div class="stat-card">
                                <div class="value">--</div>
                                <div class="label">Produits publi√©s</div>
                            </div>
                            <div class="stat-card">
                                <div class="value" style="color: var(--accent);">--</div>
                                <div class="label">Boosts actifs</div>
                            </div>
                            <div class="stat-card">
                                <div class="value" style="color: var(--success);">0 F</div>
                                <div class="label">Revenu boosts</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
                            <div
                                style="padding: 12px; background: rgba(239,68,68,0.1); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <span>Signalements produits</span>
                                <span style="font-size: 18px; font-weight: bold; color: var(--danger);">0</span>
                            </div>
                            <div
                                style="padding: 12px; background: rgba(100,116,139,0.1); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <span>Marchands suspendus</span>
                                <span style="font-size: 18px; font-weight: bold; color: var(--warning);">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- E. KPIs CONFORMIT√â -->
                <div class="card" style="margin-top: 24px; border-top: 3px solid #ef4444;">
                    <div class="card-header">
                        <h3><i class="fas fa-shield-alt" style="color: var(--danger);"></i> E. KPIs Conformit√©</h3>
                    </div>
                    <div style="padding: 20px;">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="value" style="color: var(--warning);">--</div>
                                <div class="label">Comptes suspendus</div>
                            </div>
                            <div class="stat-card">
                                <div class="value">--</div>
                                <div class="label">Demandes RGPD (acc√®s/suppression)</div>
                            </div>
                            <div class="stat-card">
                                <div class="value" style="color: var(--danger);">--</div>
                                <div class="label">Litiges ouverts</div>
                            </div>
                            <div class="stat-card">
                                <div class="value" style="color: var(--success);">--</div>
                                <div class="label">Litiges clos</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-top: 16px;">
                            <div
                                style="padding: 12px; background: rgba(59,130,246,0.1); border-radius: 8px; text-align: center;">
                                <div style="font-size: 11px; color: var(--text-muted);">D√©lai moyen litige</div>
                                <div style="font-size: 20px; font-weight: bold;">-- jours</div>
                            </div>
                            <div
                                style="padding: 12px; background: rgba(34,197,94,0.1); border-radius: 8px; text-align: center;">
                                <div style="font-size: 11px; color: var(--text-muted);">RGPD Acc√®s</div>
                                <div style="font-size: 20px; font-weight: bold;">0</div>
                            </div>
                            <div
                                style="padding: 12px; background: rgba(239,68,68,0.1); border-radius: 8px; text-align: center;">
                                <div style="font-size: 11px; color: var(--text-muted);">RGPD Suppression</div>
                                <div style="font-size: 20px; font-weight: bold;">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- F. SUPPORT (Users & Entreprise) -->
                <div class="card" style="margin-top: 24px; border-top: 3px solid #14b8a6;">
                    <div class="card-header">
                        <h3><i class="fas fa-headset" style="color: #5eead4;"></i> F. Support</h3>
                        <div class="tabs">
                            <button class="tab active" onclick="switchSupportTab('users')">üë§ Utilisateurs <span
                                    class="badge" style="background: var(--danger);">--</span></button>
                            <button class="tab" onclick="switchSupportTab('enterprise')">üè¢ Entreprises <span
                                    class="badge" style="background: var(--warning);">--</span></button>
                        </div>
                    </div>

                    <!-- Support Users Tab -->
                    <div id="support-users" class="support-tab" style="padding: 20px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h4 style="color: var(--text-muted);">Tickets Particuliers</h4>
                            <div style="display: flex; gap: 8px;">
                                <span style="font-size: 12px; color: var(--text-muted);">En attente: <strong
                                        style="color: var(--danger);">--</strong></span>
                                <span style="font-size: 12px; color: var(--text-muted);">R√©solus: <strong
                                        style="color: var(--success);">--</strong></span>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Utilisateur</th>
                                    <th>Type</th>
                                    <th>Sujet</th>
                                    <th>Priorit√©</th>
                                    <th>Statut</th>
                                    <th>Cr√©√© le</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="auditSupportTableBody">
                                <tr>
                                    <td colspan="8"
                                        style="text-align: center; color: var(--text-muted); padding: 20px;">
                                        <i class="fas fa-spinner fa-spin"></i> Chargement des tickets...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Support Enterprise Tab -->
                    <div id="support-enterprise" class="support-tab" style="padding: 20px; display: none;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h4 style="color: var(--text-muted);">Tickets Entreprises (B2B)</h4>
                            <div style="display: flex; gap: 8px;">
                                <span style="font-size: 12px; color: var(--text-muted);">Ajustements limites: <strong
                                        style="color: var(--warning);">--</strong></span>
                                <span style="font-size: 12px; color: var(--text-muted);">Facturation: <strong
                                        style="color: var(--accent);">--</strong></span>
                            </div>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Entreprise</th>
                                    <th>Type</th>
                                    <th>Sujet</th>
                                    <th>Plan actuel</th>
                                    <th>Priorit√©</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="8"
                                        style="text-align: center; color: var(--text-muted); padding: 20px;">
                                        Aucun ticket entreprise r√©cent.
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- Enterprise Limit Override Actions -->
                        <div
                            style="margin-top: 16px; padding: 16px; background: rgba(124, 58, 237, 0.1); border-radius: 8px; border-left: 4px solid var(--accent);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="font-size: 14px;">‚öôÔ∏è Actions Admin Entreprise</strong>
                                    <p style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Modifier les
                                        limites pour une entreprise sp√©cifique</p>
                                </div>
                                <button class="action-btn view" onclick="showOverrideModal()">
                                    <i class="fas fa-sliders-h"></i> G√©rer les Override
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transactions Plateforme (Modifiable) -->

                <div class="card" id="finance-transactions" style="margin-top: 24px;">
                    <div class="card-header">
                        <h3><i class="fas fa-receipt" style="color: var(--success);"></i> Transactions Plateforme (Notre
                            Argent)</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Client</th>
                                <th>Pays</th>
                                <th>Montant HT</th>
                                <th>TVA</th>
                                <th>TTC</th>
                                <th>PSP</th>
                                <th>Facture</th>
                                <th>Statut</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="10" style="text-align: center; padding: 20px;">Aucune transaction r√©cente.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- PSP User Transactions (LECTURE SEULE) -->
                <div class="card" style="margin-top: 24px; opacity: 0.85;">
                    <div class="card-header">
                        <h3><i class="fas fa-eye" style="color: #94a3b8;"></i> Flux Utilisateurs PSP (Lecture Seule)
                        </h3>
                        <span
                            style="background: rgba(100,116,139,0.3); padding: 4px 12px; border-radius: 4px; font-size: 11px; color: #94a3b8;">
                            ‚ö†Ô∏è Donn√©es indicatives - Source: PSP
                        </span>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>R√©f. PSP</th>
                                <th>Statut</th>
                                <th>Date</th>
                                <th>Cercle</th>
                                <th>Montant</th>
                                <th>PSP</th>
                            </tr>
                        </thead>
                        <tbody style="color: #94a3b8;">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 20px;">Aucun flux r√©cent.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 24px;">
                    <!-- R√©conciliation PSP -->
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-balance-scale" style="color: var(--accent);"></i> R√©conciliation PSP
                            </h3>
                        </div>
                        <div style="padding: 20px;">
                            <div style="text-align: center; color: var(--text-muted); padding: 20px;">
                                <i class="fas fa-check-circle"></i> En attente de donn√©es PSP...
                            </div>
                        </div>
                    </div>

                    <!-- Alertes Automatiques -->
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-bell" style="color: var(--warning);"></i> Alertes Automatiques</h3>
                        </div>
                        <div style="padding: 20px;">
                            <div style="text-align: center; color: var(--text-muted); padding: 20px;">
                                Aucune alerte active.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Litiges & Remboursements -->
                <div class="card" style="margin-top: 24px;">
                    <div class="card-header">
                        <h3><i class="fas fa-gavel" style="color: var(--warning);"></i> Litiges & Remboursements</h3>
                        <span
                            style="background: rgba(251,191,36,0.2); padding: 4px 12px; border-radius: 4px; font-size: 11px; color: #fcd34d;">
                            ‚ö†Ô∏è Remboursements d√©clench√©s uniquement via PSP
                        </span>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Date</th>
                                <th>Motif</th>
                                <th>R√©f. Transaction</th>
                                <th>D√©cision</th>
                                <th>Trace √©crite</th>
                                <th>Statut</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 20px; color: var(--text-muted);">
                                    Aucun litige r√©cent.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Journal Immuable (Ledger) -->
                <div class="card" id="finance-ledger" style="margin-top: 24px;">
                    <div class="card-header">
                        <h3><i class="fas fa-book" style="color: var(--accent);"></i> Journal Financier Immuable
                            (Ledger)</h3>
                        <span
                            style="background: rgba(239,68,68,0.2); padding: 4px 12px; border-radius: 4px; font-size: 11px; color: #fca5a5;">
                            ‚ùå Pas de suppression | ‚úÖ √âcritures correctives uniquement
                        </span>
                    </div>
                    <table style="font-size: 11px;">
                        <thead>
                            <tr>
                                <th>Timestamp UTC</th>
                                <th>Type</th>
                                <th>Action</th>
                                <th>User/Enterprise</th>
                                <th>PSP ID</th>
                                <th>Montant</th>
                            </tr>
                        </thead>
                        <tbody style="font-family: monospace;" id="financeTableBody">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 20px; color: var(--text-muted);">
                                    Journal vide.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Export & Archivage L√©gal -->
                <div class="card" style="margin-top: 24px;">
                    <div class="card-header">
                        <h3><i class="fas fa-archive" style="color: var(--accent);"></i> Exports & Archivage L√©gal</h3>
                    </div>
                    <div style="padding: 20px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                        <button class="action-btn view" style="padding: 16px; text-align: center;"
                            onclick="exportData('financeTableBody', 'csv')">
                            <i class="fas fa-file-csv" style="font-size: 24px; display: block; margin-bottom: 8px;"></i>
                            Export Mensuel (CSV)
                        </button>
                        <button class="action-btn view" style="padding: 16px; text-align: center;"
                            onclick="exportData('financeTableBody', 'csv')">
                            <i class="fas fa-file-csv" style="font-size: 24px; display: block; margin-bottom: 8px;"></i>
                            Export Trimestriel
                        </button>
                        <button class="action-btn view" style="padding: 16px; text-align: center;"
                            onclick="exportData('finance-ledger', 'json')">
                            <i class="fas fa-file-archive"
                                style="font-size: 24px; display: block; margin-bottom: 8px;"></i>
                            Archive Annuelle 2025
                        </button>
                        <button class="action-btn view" style="padding: 16px; text-align: center;"
                            onclick="exportData('finance-ledger', 'json')">
                            <i class="fas fa-book" style="font-size: 24px; display: block; margin-bottom: 8px;"></i>
                            Export Ledger Complet
                        </button>
                    </div>
                    <div
                        style="padding: 16px; background: rgba(59,130,246,0.1); font-size: 11px; color: var(--text-muted);">
                        <i class="fas fa-info-circle"></i> Archivage 10 ans (UE) - Tous les exports sont sign√©s et
                        horodat√©s.
                    </div>
                </div>

                <!-- Ce qu'on NE montre PAS -->
                <div
                    style="margin-top: 24px; padding: 16px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); border-radius: 8px;">
                    <div style="font-weight: bold; color: var(--danger); margin-bottom: 8px;"><i class="fas fa-ban"></i>
                        Ce dashboard NE contient PAS :</div>
                    <div style="display: flex; gap: 16px; flex-wrap: wrap; font-size: 12px; color: #fca5a5;">
                        <span>‚ùå Solde utilisateur</span>
                        <span>‚ùå Portefeuille interne</span>
                        <span>‚ùå Agr√©gation des fonds</span>
                        <span>‚ùå Modification manuelle de montants</span>
                        <span>‚ùå Promesse de rendement</span>
                    </div>
                </div>
            </section>

            <!-- Reports Section -->
            <section class="section" id="reports">
                <div class="header">
                    <h1>Signalements & Litiges</h1>
                    <div style="display: flex; gap: 8px;">
                        <button class="action-btn view" onclick="exportData('reports', 'csv')"><i
                                class="fas fa-file-csv"></i> Export CSV</button>
                        <button class="action-btn view" onclick="exportData('reports', 'json')"><i
                                class="fas fa-file-code"></i> Export JSON</button>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="value" style="color: var(--danger);">--</div>
                        <div class="label">Ouverts</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" style="color: var(--warning);">--</div>
                        <div class="label">En cours</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" style="color: var(--success);">--</div>
                        <div class="label">R√©solus (7j)</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" style="color: var(--accent);">--</div>
                        <div class="label">Escalade juridique</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-flag" style="color: var(--danger);"></i> Signalements actifs</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Type</th>
                                <th>Cible</th>
                                <th>Signal√© par</th>
                                <th>Gravit√©</th>
                                <th>Depuis</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 20px; color: var(--text-muted);">
                                    Aucun signalement actif.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Security Section - Centre de S√©curit√© Global -->
            <section class="section" id="security">
                <div class="header">
                    <h1>üõ°Ô∏è Centre de S√©curit√© Plateforme</h1>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <span
                            style="background: rgba(34,197,94,0.2); color: #86efac; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: bold;">
                            <i class="fas fa-check-circle"></i> √âTAT: OK
                        </span>
                        <button class="action-btn view" onclick="exportAllData('json')"><i class="fas fa-download"></i>
                            Export S√©curit√©</button>
                    </div>
                </div>

                <!-- 1Ô∏è‚É£ Vue Cockpit - √âtat G√©n√©ral -->
                <div
                    style="background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(59,130,246,0.1)); border: 1px solid rgba(34,197,94,0.3); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
                        <div
                            style="text-align: center; padding: 16px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            <div style="font-size: 32px; margin-bottom: 8px;">üü¢</div>
                            <div style="font-weight: bold; color: var(--success);">Plateforme Active</div>
                            <div style="font-size: 11px; color: var(--text-muted);">Aucun incident</div>
                        </div>
                        <div
                            style="text-align: center; padding: 16px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 4px;">Derni√®re
                                activit√© admin</div>
                            <div style="font-size: 18px; font-weight: bold;">--</div>
                            <div style="font-size: 11px; color: var(--text-muted);">Aucune activit√© r√©cente</div>
                        </div>
                        <div
                            style="text-align: center; padding: 16px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 4px;">Anomalies
                                d√©tect√©es (24h)</div>
                            <div style="font-size: 18px; font-weight: bold; color: var(--warning);">--</div>
                            <div style="font-size: 11px; color: var(--text-muted);">--</div>
                        </div>
                        <div
                            style="text-align: center; padding: 16px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 4px;">Versions en
                                production</div>
                            <div style="font-size: 12px;">
                                <div>üì± Android: <strong>2.4.1</strong></div>
                                <div>üçé iOS: <strong>2.4.0</strong></div>
                                <div>üåê Web: <strong>2.4.2</strong></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Security & Reports Dashboard -->
                <div class="card">
                    <div style="padding: 40px; text-align: center; color: var(--text-muted);">
                        <h3><i class="fas fa-shield-alt" style="color: var(--accent);"></i> Rapports & S√©curit√©</h3>
                        <p>Les rapports d√©taill√©s et le tableau de bord de s√©curit√© seront disponibles prochainement.
                        </p>
                        <p>Veuillez consulter la section <a href="#"
                                onclick="document.querySelector('[data-section=\'audit\']').click(); return false;">Audit
                                & Conformit√©</a> pour les logs r√©els.</p>
                    </div>
                </div>
            </section>

            <!-- Audit Section -->
            <section class="section" id="audit">
                <div class="header">
                    <h1>Audit & Conformit√©</h1>
                    <button class="action-btn approve" style="padding: 10px 20px;"><i class="fas fa-download"></i>
                        Export ACPR</button>
                </div>
                <div class="security-badge"
                    style="margin-bottom: 20px; background: rgba(22,163,74,0.2); border-color: var(--success); color: #86efac;">
                    <i class="fas fa-lock"></i>
                    Journal immuable - Ces donn√©es ne peuvent pas √™tre modifi√©es
                </div>
                <div class="tabs">
                    <button class="tab active">Actions admin</button>
                    <button class="tab">CGU Historique</button>
                    <button class="tab">Consentements</button>
                    <button class="tab">Export</button>
                </div>
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>Date/Heure</th>
                                <th>Admin</th>
                                <th>Action</th>
                                <th>Cible</th>
                                <th>IP</th>
                            </tr>
                        </thead>
                        <tbody id="auditTableBody">
                            <!-- Dynamic Content -->
                            <tr>
                                <td colspan="5" style="text-align:center; color:var(--text-muted); padding:20px;">
                                    Chargement de l'audit...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Support Section -->
            <section class="section" id="support">
                <div class="header">
                    <h1>Support & Tickets</h1>
                    <div style="display: flex; gap: 8px;">
                        <button class="action-btn view" onclick="exportData('support', 'csv')"><i
                                class="fas fa-file-csv"></i> Export CSV</button>
                        <button class="action-btn view" onclick="exportData('support', 'json')"><i
                                class="fas fa-file-code"></i> Export JSON</button>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="value" style="color: var(--danger);">--</div>
                        <div class="label">Tickets ouverts</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" style="color: var(--warning);">--</div>
                        <div class="label">En attente</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" style="color: var(--success);">--</div>
                        <div class="label">R√©solus (7j)</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" style="color: var(--accent);">--</div>
                        <div class="label">Temps moyen r√©ponse</div>
                    </div>
                </div>
                <div class="tabs">
                    <button class="tab active">Ouverts</button>
                    <button class="tab">En cours</button>
                    <button class="tab">R√©solus</button>
                    <button class="tab">Statistiques</button>
                </div>
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>Ticket</th>
                                <th>Utilisateur</th>
                                <th>Cat√©gorie</th>
                                <th>Sujet</th>
                                <th>Priorit√©</th>
                                <th>SLA</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="supportTableBody">
                            <!-- Dynamic Content -->
                            <tr>
                                <td colspan="7" style="text-align:center; color:var(--text-muted); padding:20px;">Aucun
                                    ticket ouvert</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- Static template section removed as they are now inside the modal -->

            </section>

            <!-- Campaigns Section -->
            <section class="section" id="campaigns">
                <div class="header">
                    <h1>Campagnes Marketing</h1>
                    <div style="display: flex; gap: 8px;">
                        <button class="action-btn view" onclick="exportData('campaigns', 'csv')"><i
                                class="fas fa-file-csv"></i> Export CSV</button>
                        <button class="action-btn view" onclick="exportData('campaigns', 'json')"><i
                                class="fas fa-file-code"></i> Export JSON</button>
                        <button class="action-btn approve" style="padding: 10px 20px;" onclick="openCampaignModal()"><i
                                class="fas fa-plus"></i>
                            Nouvelle campagne</button>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="value">0</div>
                        <div class="label">Brouillons</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" style="color: var(--warning);">0</div>
                        <div class="label">Programm√©es</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" style="color: var(--success);">0</div>
                        <div class="label">Envoy√©es (30j)</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" style="color: var(--accent);">--%</div>
                        <div class="label">Taux ouverture moy.</div>
                    </div>
                </div>
                <div class="tabs">
                    <button class="tab active">Toutes</button>
                    <button class="tab">Brouillons</button>
                    <button class="tab">Programm√©es</button>
                    <button class="tab">Envoy√©es</button>
                    <button class="tab">Templates</button>
                </div>
                <div class="card">
                    <table>
                        <thead>
                            <tr>
                                <th>Campagne</th>
                                <th>Type</th>
                                <th>Cible</th>
                                <th>Statut</th>
                                <th>Envoy√©e/Prog.</th>
                                <th>Stats</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="campaignsTableBody">
                            <!-- Dynamic Content -->
                            <tr>
                                <td colspan="7" style="text-align:center; color:var(--text-muted); padding:20px;">
                                    Chargement des campagnes...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3><i class="fas fa-users" style="color: var(--accent);"></i> Segments d'audience</h3>
                    </div>
                    <div style="padding: 20px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                        <div
                            style="padding: 16px; background: rgba(59,130,246,0.1); border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold;">--</div>
                            <div style="color: var(--text-muted); font-size: 12px;">Tous utilisateurs</div>
                        </div>
                        <div
                            style="padding: 16px; background: rgba(34,197,94,0.1); border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px; font-weight: bold;">--</div>
                            <div style="color: var(--text-muted); font-size: 12px;">Nouveaux (< 7j)</div>
                            </div>
                            <div
                                style="padding: 16px; background: rgba(245,158,11,0.1); border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold;">--</div>
                                <div style="color: var(--text-muted); font-size: 12px;">Inactifs (> 30j)</div>
                            </div>
                            <div
                                style="padding: 16px; background: rgba(168,85,247,0.1); border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold;">--</div>
                                <div style="color: var(--text-muted); font-size: 12px;">Marchands</div>
                            </div>
                        </div>
                    </div>
            </section>

            <!-- Referral/Parrainage Section -->
            <section class="section" id="referral">
                <div class="header">
                    <h1>Parrainage & Campagnes de Parrainage</h1>
                    <div style="display: flex; gap: 8px;">
                        <button class="action-btn view" onclick="exportData('referral', 'csv')"><i
                                class="fas fa-file-csv"></i> Export CSV</button>
                        <button class="action-btn view" onclick="exportData('referral', 'json')"><i
                                class="fas fa-file-code"></i> Export JSON</button>
                        <button class="action-btn approve" style="padding: 10px 20px;"
                            onclick="openReferralCampaignModal()"><i class="fas fa-plus"></i>
                            Nouvelle campagne</button>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="value" style="color: var(--success);">0</div>
                        <div class="label">Parrainages r√©ussis</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" style="color: var(--warning);">0</div>
                        <div class="label">En attente</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" style="color: var(--accent);">0 F</div>
                        <div class="label">R√©compenses distribu√©es</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" style="color: var(--success);">--%</div>
                        <div class="label">Taux de conversion</div>
                    </div>
                </div>

                <!-- Active Campaigns -->
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-gift" style="color: var(--accent);"></i> Campagnes de Parrainage</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Campagne</th>
                                <th>Type de r√©compense</th>
                                <th>Montant</th>
                                <th>P√©riode</th>
                                <th>Parrainages</th>
                                <th>Distribu√©</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="8" style="text-align:center; padding:20px; color:var(--text-muted);">Aucune
                                    campagne de parrainage active.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-top: 20px;">
                    <!-- Recent Referrals -->
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-user-friends" style="color: var(--accent);"></i> Parrainages R√©cents
                            </h3>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Parrain</th>
                                    <th>Filleul</th>
                                    <th>Code</th>
                                    <th>Date</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="referralTableBody">
                                <!-- Dynamic Content -->
                                <tr>
                                    <td colspan="6" style="text-align:center; color:var(--text-muted); padding:20px;">
                                        Aucun parrainage r√©cent</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Top Referrers -->
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-trophy" style="color: #fbbf24;"></i> Top Parrains</h3>
                        </div>
                        <div style="padding: 20px; text-align: center; color: var(--text-muted);">
                            Aucune donn√©e disponible.
                        </div>
                    </div>
                </div>

                <!-- Referral Settings -->
                <div class="card" style="margin-top: 20px;">
                    <div class="card-header">
                        <h3><i class="fas fa-sliders-h" style="color: var(--accent);"></i> Param√®tres de Parrainage</h3>
                    </div>
                    <div style="padding: 20px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                        <div style="padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">CONDITIONS DE
                                VALIDATION</div>
                            <div>Filleul doit rejoindre au moins <strong>1 cercle</strong></div>
                        </div>
                        <div style="padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">LIMITE PAR
                                UTILISATEUR</div>
                            <div>Maximum <strong>50 filleuls</strong> par parrain</div>
                        </div>
                        <div style="padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">LIEN DE
                                PARRAINAGE</div>
                            <div><code
                                    style="background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 4px; font-size: 12px;">https://tontetic.app/join?ref=CODE</code>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section class="section" id="settings">
                <div class="header">
                    <h1>Param√®tres Globaux</h1>
                </div>

                <!-- üí≥ FORMULES UTILISATEUR -->
                <div class="card" style="margin-bottom: 24px; border-top: 3px solid var(--accent);">
                    <div class="card-header">
                        <h3><i class="fas fa-gem" style="color: var(--accent);"></i> Formules Utilisateur</h3>
                        <div>
                            <span
                                style="background: rgba(34,197,94,0.2); padding: 4px 12px; border-radius: 4px; font-size: 11px; color: #86efac; margin-right: 8px;">
                                -- plans actifs
                            </span>
                            <button class="action-btn view" style="padding: 6px 12px; font-size: 11px;"
                                onclick="document.querySelector('[data-section=\'plans\']').click()">
                                <i class="fas fa-edit"></i> Modifier
                            </button>
                        </div>
                    </div>
                    <div style="padding: 20px;">
                        <div style="padding: 20px; text-align: center; color: var(--text-muted);">
                            Veuillez consulter la section "Gestion des Plans" pour les formules.
                        </div>

                        <!-- Stats abonnements -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-top: 20px;">
                            <div
                                style="padding: 16px; background: rgba(34,197,94,0.1); border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--success);">0</div>
                                <div style="font-size: 11px;">Total abonn√©s</div>
                            </div>
                            <div
                                style="padding: 16px; background: rgba(59,130,246,0.1); border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #60a5fa;">0</div>
                                <div style="font-size: 11px;">Abonn√©s payants</div>
                            </div>
                            <div
                                style="padding: 16px; background: rgba(34,197,94,0.1); border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: var(--success);">0 ‚Ç¨</div>
                                <div style="font-size: 11px;">MRR Utilisateurs</div>
                            </div>
                            <div
                                style="padding: 16px; background: rgba(251,191,36,0.1); border-radius: 8px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #fbbf24;">--%</div>
                                <div style="font-size: 11px;">Taux conversion</div>
                            </div>
                        </div>

                        <!-- R√®gles backend -->
                        <div
                            style="margin-top: 20px; padding: 16px; background: rgba(59,130,246,0.1); border-radius: 8px; font-size: 11px;">
                            <strong>üìã R√®gles Backend (v√©rification serveur):</strong>
                            <ul style="margin: 8px 0 0 20px; color: var(--text-muted);">
                                <li>√Ä chaque cr√©ation: "Utilisateur d√©passe-t-il sa limite de tontines?"</li>
                                <li>√Ä chaque invitation: "Nombre de participants autoris√©?"</li>
                                <li>Toutes fonctionnalit√©s actives pour tous (vote, al√©atoire, messagerie, wallet, IA)
                                </li>
                                <li>UI: montrer limite restante + proposer upgrade si n√©cessaire</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-users" style="color: var(--accent);"></i> Limites par d√©faut (Nouveaux)
                            </h3>
                        </div>
                        <div style="padding: 20px;">
                            <div style="margin-bottom: 12px; font-size: 13px; color: var(--text-muted);">R√©f√©rence pour
                                les nouveaux inscrits (Plan Gratuit)</div>
                            <div
                                style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <span>Cercles max par d√©faut</span>
                                <span id="defaultMaxCircles"
                                    style="background: rgba(255,255,255,0.1); padding: 4px 12px; border-radius: 4px; font-weight: bold;">1</span>
                            </div>
                            <div
                                style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <span>Membres max par d√©faut</span>
                                <span id="defaultMaxMembers"
                                    style="background: rgba(255,255,255,0.1); padding: 4px 12px; border-radius: 4px; font-weight: bold;">5</span>
                            </div>
                            <div style="margin-top: 16px;">
                                <button class="action-btn view" onclick="syncGlobalLimitsWithPlans()"
                                    style="width: 100%;">Synchroniser avec Plan Gratuit</button>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-store" style="color: var(--accent);"></i> R√®gles marchands</h3>
                        </div>
                        <div style="padding: 20px;">
                            <div
                                style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <span>Produits max (nouveau)</span>
                                <span
                                    style="background: rgba(255,255,255,0.1); padding: 4px 12px; border-radius: 4px; font-weight: bold;">10</span>
                            </div>
                            <div
                                style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <span>Produits max (v√©rifi√©)</span>
                                <span
                                    style="background: rgba(255,255,255,0.1); padding: 4px 12px; border-radius: 4px; font-weight: bold;">100</span>
                            </div>
                            <div
                                style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <span>Boost max simultan√©s</span>
                                <span
                                    style="background: rgba(255,255,255,0.1); padding: 4px 12px; border-radius: 4px; font-weight: bold;">3</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px 0;">
                                <span>D√©lai mod√©ration</span>
                                <span
                                    style="background: rgba(255,255,255,0.1); padding: 4px 12px; border-radius: 4px; font-weight: bold;">24h</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card" style="margin-top: 24px;">
                    <div class="card-header">
                        <h3><i class="fas fa-globe" style="color: var(--accent);"></i> Pays actifs</h3>
                    </div>
                    <div style="padding: 20px; display: flex; gap: 12px; flex-wrap: wrap;">
                        <span
                            style="padding: 8px 16px; background: rgba(22,163,74,0.2); border-radius: 20px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-check-circle" style="color: var(--success);"></i> üá∏üá≥ S√©n√©gal
                        </span>
                        <span
                            style="padding: 8px 16px; background: rgba(22,163,74,0.2); border-radius: 20px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-check-circle" style="color: var(--success);"></i> üá®üáÆ C√¥te d'Ivoire
                        </span>
                        <span
                            style="padding: 8px 16px; background: rgba(22,163,74,0.2); border-radius: 20px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-check-circle" style="color: var(--success);"></i> üá≤üá± Mali
                        </span>
                        <span
                            style="padding: 8px 16px; background: rgba(100,116,139,0.2); border-radius: 20px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-times-circle" style="color: var(--text-muted);"></i> üáßüá´ Burkina Faso
                        </span>
                        <span
                            style="padding: 8px 16px; background: rgba(100,116,139,0.2); border-radius: 20px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-times-circle" style="color: var(--text-muted);"></i> üá¨üá≥ Guin√©e
                        </span>
                    </div>
                </div>

                <!-- Admin Management -->
                <div class="card" style="margin-top: 24px;">
                    <div class="card-header">
                        <h3><i class="fas fa-user-shield" style="color: var(--accent);"></i> Gestion des Administrateurs
                            & Permissions</h3>
                        <button class="action-btn approve" onclick="addAdminManual()">+ Ajouter admin</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Admin</th>
                                <th>Email</th>
                                <th>R√¥le</th>
                                <th>MFA</th>
                                <th>Statut</th>
                                <th>Derni√®re connexion</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminsTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; color: var(--text-muted); padding: 20px;">
                                    <i class="fas fa-spinner fa-spin"></i> Chargement des administrateurs...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Role Permissions Matrix -->
                <div class="card" style="margin-top: 24px;">
                    <div class="card-header">
                        <h3><i class="fas fa-key" style="color: var(--accent);"></i> Matrice des Permissions par R√¥le
                        </h3>
                    </div>
                    <div style="overflow-x: auto;">
                        <table style="font-size: 12px;">
                            <thead>
                                <tr>
                                    <th>Section</th>
                                    <th>üëë Super Admin</th>
                                    <th>üîë Admin</th>
                                    <th>üõ°Ô∏è Mod√©rateur</th>
                                    <th>üí¨ Support</th>
                                    <th>üìä Analyste</th>
                                    <th>üì¢ Marketing</th>
                                    <th>üëÅÔ∏è Lecteur</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Tableau de bord</td>
                                    <td><span style="color: var(--success);">‚úèÔ∏è Modif</span></td>
                                    <td><span style="color: var(--success);">‚úèÔ∏è Modif</span></td>
                                    <td><span style="color: #60a5fa;">üëÅÔ∏è Lecture</span></td>
                                    <td><span style="color: #60a5fa;">üëÅÔ∏è Lecture</span></td>
                                    <td><span style="color: #60a5fa;">üëÅÔ∏è Lecture</span></td>
                                    <td><span style="color: #60a5fa;">üëÅÔ∏è Lecture</span></td>
                                    <td><span style="color: #60a5fa;">üëÅÔ∏è Lecture</span></td>
                                </tr>
                                <tr>
                                    <td>Utilisateurs</td>
                                    <td><span style="color: var(--success);">‚úèÔ∏è Modif</span></td>
                                    <td><span style="color: var(--success);">‚úèÔ∏è Modif</span></td>
                                    <td><span style="color: #60a5fa;">üëÅÔ∏è Lecture</span></td>
                                    <td><span style="color: #60a5fa;">üëÅÔ∏è Lecture</span></td>
                                    <td><span style="color: #60a5fa;">üëÅÔ∏è Lecture</span></td>
                                    <td><span style="color: #60a5fa;">üëÅÔ∏è Lecture</span></td>
                                    <td><span style="color: #60a5fa;">üëÅÔ∏è Lecture</span></td>
                                </tr>
                                <tr>
                                    <td>Cercles</td>
                                    <td><span style="color: var(--success);">‚úèÔ∏è Modif</span></td>
                                    <td><span style="color: var(--success);">‚úèÔ∏è Modif</span></td>
                                    <td><span style="color: #60a5fa;">üëÅÔ∏è Lecture</span></td>
                                    <td><span style="color: #60a5fa;">üëÅÔ∏è Lecture</span></td>
                                    <td><span style="color: #60a5fa;">üëÅÔ∏è Lecture</span></td>
                                    <td><span style="color: var(--text-muted);">üö´ Aucun</span></td>
                                    <td><span style="color: #60a5fa;">üëÅÔ∏è Lecture</span></td>
                                </tr>
                                <tr>
                                    <td>Marchands</td>
                                    <td><span style="color: var(--success);">‚úèÔ∏è Modif</span></td>
                                    <td><span style="color: var(--success);">‚úèÔ∏è Modif</span></td>
                                    <td><span style="color: #60a5fa;">üëÅÔ∏è Lecture</span></td>
                                    <td><span style="color: var(--text-muted);">üö´ Aucun</span></td>
                                    <td><span style="color: #60a5fa;">üëÅÔ∏è Lecture</span></td>
                                    <td><span style="color: var(--text-muted);">üö´ Aucun</span></td>
                                    <td><span style="color: var(--text-muted);">üö´ Aucun</span></td>
                                </tr>
                                <tr>
                                    <td>Paiements</td>
                                    <td><span style="color: #60a5fa;">üëÅÔ∏è Lecture</span></td>
                                    <td><span style="color: #60a5fa;">üëÅÔ∏è Lecture</span></td>
                                    <td><span style="color: var(--text-muted);">üö´ Aucun</span></td>
                                    <td><span style="color: var(--text-muted);">üö´ Aucun</span></td>
                                    <td><span style="color: #60a5fa;">üëÅÔ∏è Lecture</span></td>
                                    <td><span style="color: var(--text-muted);">üö´ Aucun</span></td>
                                    <td><span style="color: var(--text-muted);">üö´ Aucun</span></td>
                                </tr>
                                <tr>
                                    <td>Mod√©ration</td>
                                    <td><span style="color: var(--success);">‚úèÔ∏è Modif</span></td>
                                    <td><span style="color: var(--success);">‚úèÔ∏è Modif</span></td>
                                    <td><span style="color: var(--success);">‚úèÔ∏è Modif</span></td>
                                    <td><span style="color: var(--text-muted);">üö´ Aucun</span></td>
                                    <td><span style="color: #60a5fa;">üëÅÔ∏è Lecture</span></td>
                                    <td><span style="color: var(--text-muted);">üö´ Aucun</span></td>
                                    <td><span style="color: var(--text-muted);">üö´ Aucun</span></td>
                                </tr>
                                <tr>
                                    <td>Support</td>
                                    <td><span style="color: var(--success);">‚úèÔ∏è Modif</span></td>
                                    <td><span style="color: var(--success);">‚úèÔ∏è Modif</span></td>
                                    <td><span style="color: var(--success);">‚úèÔ∏è Modif</span></td>
                                    <td><span style="color: var(--success);">‚úèÔ∏è Modif</span></td>
                                    <td><span style="color: #60a5fa;">üëÅÔ∏è Lecture</span></td>
                                    <td><span style="color: var(--text-muted);">üö´ Aucun</span></td>
                                    <td><span style="color: var(--text-muted);">üö´ Aucun</span></td>
                                </tr>
                                <tr>
                                    <td>Campagnes</td>
                                    <td><span style="color: var(--success);">‚úèÔ∏è Modif</span></td>
                                    <td><span style="color: var(--success);">‚úèÔ∏è Modif</span></td>
                                    <td><span style="color: var(--text-muted);">üö´ Aucun</span></td>
                                    <td><span style="color: var(--text-muted);">üö´ Aucun</span></td>
                                    <td><span style="color: #60a5fa;">üëÅÔ∏è Lecture</span></td>
                                    <td><span style="color: var(--success);">‚úèÔ∏è Modif</span></td>
                                    <td><span style="color: var(--text-muted);">üö´ Aucun</span></td>
                                </tr>
                                <tr>
                                    <td>Parrainage</td>
                                    <td><span style="color: var(--success);">‚úèÔ∏è Modif</span></td>
                                    <td><span style="color: var(--success);">‚úèÔ∏è Modif</span></td>
                                    <td><span style="color: var(--text-muted);">üö´ Aucun</span></td>
                                    <td><span style="color: var(--text-muted);">üö´ Aucun</span></td>
                                    <td><span style="color: #60a5fa;">üëÅÔ∏è Lecture</span></td>
                                    <td><span style="color: var(--success);">‚úèÔ∏è Modif</span></td>
                                    <td><span style="color: var(--text-muted);">üö´ Aucun</span></td>
                                </tr>
                                <tr>
                                    <td>Param√®tres</td>
                                    <td><span style="color: var(--success);">‚úèÔ∏è Modif</span></td>
                                    <td><span style="color: #60a5fa;">üëÅÔ∏è Lecture</span></td>
                                    <td><span style="color: var(--text-muted);">üö´ Aucun</span></td>
                                    <td><span style="color: var(--text-muted);">üö´ Aucun</span></td>
                                    <td><span style="color: var(--text-muted);">üö´ Aucun</span></td>
                                    <td><span style="color: var(--text-muted);">üö´ Aucun</span></td>
                                    <td><span style="color: var(--text-muted);">üö´ Aucun</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div
                        style="padding: 16px; background: rgba(59,130,246,0.1); border-radius: 0 0 12px 12px; font-size: 12px; color: var(--text-muted);">
                        <i class="fas fa-info-circle"></i> <strong>Note:</strong> Les paiements sont toujours en lecture
                        seule (s√©curit√©). Les permissions personnalis√©es peuvent surcharger les r√¥les par d√©faut.
                    </div>
                </div>

                <!-- Maintenance & Security -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 24px;">
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-tools" style="color: var(--warning);"></i> Mode Maintenance</h3>
                        </div>
                        <div style="padding: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: rgba(59,130,246,0.1); border-radius: 8px; margin-bottom: 16px;"
                                id="maintenanceStatusContainer">
                                <div>
                                    <div style="font-weight: bold;">Statut actuel</div>
                                    <div id="maintenanceStatusText" style="color: var(--success);">üü¢ Plateforme active
                                    </div>
                                </div>
                                <button class="action-btn suspend" id="btnToggleMaintenance"
                                    onclick="toggleMaintenance()">Chargement...</button>
                            </div>
                            <div style="font-size: 12px; color: var(--text-muted);">
                                <div><strong>Derni√®re mise √† jour:</strong> <span id="maintenanceLastUpdated">-</span>
                                </div>
                                <div id="maintenanceReason" style="margin-top: 4px; font-style: italic;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-shield-alt" style="color: var(--success);"></i> S√©curit√© MFA</h3>
                        </div>
                        <div style="padding: 20px;">
                            <div
                                style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <span>MFA obligatoire</span>
                                <span
                                    style="background: var(--success); padding: 4px 12px; border-radius: 4px;">ACTIV√â</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px 0;">
                                <span>Admins avec MFA</span>
                                <span style="color: var(--success);">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Email & PSP -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 24px;">
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-envelope" style="color: var(--accent);"></i> Emails</h3>
                        </div>
                        <div style="padding: 20px;">
                            <div
                                style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <span>SMTP</span>
                                <span style="color: var(--success);">‚úì Connect√©</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px 0;">
                                <span>D√©livrabilit√©</span>
                                <span style="color: var(--success);">--%</span>
                            </div>
                            <button class="action-btn view" style="margin-top: 12px; width: 100%;">G√©rer
                                templates</button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-credit-card" style="color: var(--accent);"></i> PSP</h3>
                        </div>
                        <div style="padding: 20px;">
                            <div
                                style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <span>Stripe</span>
                                <span class="status active">Production</span>
                            </div>
                            <div
                                style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <span>Wave</span>
                                <span class="status active">Production</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 12px 0;">
                                <span>PayPal</span>
                                <span class="status pending">Test</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Update timestamp
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('fr-FR');

        // State
        let allPlans = [];

        // Login handler
        document.getElementById('loginForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = e.target.querySelector('button');
            const originalText = btn.innerHTML;

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connexion...';
            btn.disabled = true;

            try {
                // FORCE PERSISTENCE
                await firebaseUtils.setPersistence(window.auth, firebaseUtils.browserLocalPersistence);
                const userCredential = await firebaseUtils.signInWithEmailAndPassword(window.auth, email, password);
                const user = userCredential.user;

                // Get ID Token for Claims verification
                const idTokenResult = await user.getIdTokenResult(true); // Force refresh
                const claims = idTokenResult.claims;
                console.log('[DEBUG] Token Claims:', claims);

                // Role Verification (Combined Claims + Firestore)
                let userData = null;
                try {
                    const userDoc = await firebaseUtils.getDoc(firebaseUtils.doc(window.db, 'users', user.uid));
                    userData = userDoc.exists() ? userDoc.data() : null;
                    console.log('[DEBUG] Firestore data:', userData);
                } catch (dbError) {
                    console.warn('[DEBUG] Firestore read failed (might be permissions):', dbError);
                }

                const hasAdminClaim = (claims.admin === true || claims.super_admin === true);
                const roleInDb = userData ? userData.role : 'aucun';

                if (!hasAdminClaim && roleInDb !== 'admin' && roleInDb !== 'super_admin') {
                    console.error('‚ùå Access Denied: No admin claim and no database role.');
                    await firebaseUtils.signOut(window.auth);
                    throw new Error(`Acc√®s refus√©.\n\nDroits d√©tect√©s :\n- Custom Claim: ${hasAdminClaim ? '‚úÖ' : '‚ùå'}\n- R√¥le Firestore: ${roleInDb}\n\nUID: ${user.uid}`);
                }

                console.log('[DEBUG] Access Granted! Claim:', hasAdminClaim, 'Role:', roleInDb);
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                initRealtimeListeners();

            } catch (error) {
                console.error('[DEBUG] Login workflow failed:', error);
                alert(error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function () {
                const sectionId = this.dataset.section;

                // Update nav
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                this.classList.add('active');

                // Update sections
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.getElementById(sectionId).classList.add('active');

                // Contextual actions
                if (sectionId === 'plans') {
                    refreshPlans();
                }

                // Added for Global Settings (V15)
                if (sectionId === 'settings') {
                    initGlobalSettings();
                }
            });
        });

        // Security: No fund access
        console.log('%c‚ö†Ô∏è S√âCURIT√â: Aucun acc√®s aux fonds depuis ce back-office',
            'color: red; font-size: 16px; font-weight: bold;');

        // ============ GLOBAL SETTINGS FUNCTIONS (V15) ============

        let globalSettingsInitialized = false;
        async function initGlobalSettings() {
            if (globalSettingsInitialized) return;
            console.log('[CONFIG] Initializing global settings listener...');

            // Listen to app_settings
            const configRef = firebaseUtils.doc(window.db, 'config', 'app_settings');
            firebaseUtils.onSnapshot(configRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    updateGlobalSettingsUI(data);
                } else {
                    // Create default config if missing
                    firebaseUtils.setDoc(configRef, {
                        maintenance_mode: false,
                        last_updated: firebaseUtils.serverTimestamp(),
                        maintenance_reason: '',
                        default_max_circles: 1,
                        default_max_members: 5
                    });
                }
            });
            globalSettingsInitialized = true;
        }

        function updateGlobalSettingsUI(data) {
            const isMaintenance = data.maintenance_mode || false;
            const statusText = document.getElementById('maintenanceStatusText');
            const statusContainer = document.getElementById('maintenanceStatusContainer');
            const btnToggle = document.getElementById('btnToggleMaintenance');
            const lastUpdated = document.getElementById('maintenanceLastUpdated');
            const reasonElement = document.getElementById('maintenanceReason');

            if (isMaintenance) {
                statusText.innerHTML = 'üî¥ En maintenance';
                statusText.style.color = 'var(--danger)';
                statusContainer.style.background = 'rgba(239, 68, 68, 0.1)';
                btnToggle.innerHTML = 'D√©sactiver maintenance';
                btnToggle.className = 'action-btn approve';
            } else {
                statusText.innerHTML = 'üü¢ Plateforme active';
                statusText.style.color = 'var(--success)';
                statusContainer.style.background = 'rgba(34, 197, 94, 0.1)';
                btnToggle.innerHTML = 'Activer maintenance';
                btnToggle.className = 'action-btn suspend';
            }

            if (data.last_updated) {
                const date = data.last_updated.toDate ? data.last_updated.toDate() : new Date(data.last_updated);
                lastUpdated.textContent = date.toLocaleString('fr-FR');
            }

            reasonElement.textContent = data.maintenance_reason || '';

            // Update default limits
            document.getElementById('defaultMaxCircles').textContent = data.default_max_circles || 1;
            document.getElementById('defaultMaxMembers').textContent = data.default_max_members || 5;
            document.getElementById('limitEuro').value = data.max_contribution_euro || 500;
            document.getElementById('limitFcfa').value = data.max_contribution_fcfa || 325000;
        }

        async function saveGlobalLimits() {
            const limitEuro = parseFloat(document.getElementById('limitEuro').value);
            const limitFcfa = parseFloat(document.getElementById('limitFcfa').value);

            const configRef = firebaseUtils.doc(window.db, 'config', 'app_settings');
            try {
                await firebaseUtils.updateDoc(configRef, {
                    max_contribution_euro: limitEuro,
                    max_contribution_fcfa: limitFcfa,
                    last_updated: firebaseUtils.serverTimestamp()
                });
                alert("Limites de cotisation mises √† jour !");
            } catch (error) {
                alert("Erreur : " + error.message);
            }
        }

        async function toggleMaintenance() {
            const configRef = firebaseUtils.doc(window.db, 'config', 'app_settings');
            const docSnap = await firebaseUtils.getDoc(configRef);
            const current = docSnap.exists() ? docSnap.data().maintenance_mode : false;

            const newState = !current;
            let maintenanceReason = '';

            if (newState) {
                maintenanceReason = prompt("Raison de la maintenance (affich√© aux utilisateurs) :", "Mise √† jour technique en cours");
                if (maintenanceReason === null) return;
            }

            try {
                await firebaseUtils.updateDoc(configRef, {
                    maintenance_mode: newState,
                    maintenance_reason: maintenanceReason,
                    last_updated: firebaseUtils.serverTimestamp()
                });
                console.log('[AUDIT] Maintenance mode toggled to:', newState);
            } catch (error) {
                alert("Erreur lors de la mise √† jour : " + error.message);
            }
        }

        async function syncGlobalLimitsWithPlans() {
            // Fetch FREE plan to get baseline limits
            const plansRef = firebaseUtils.collection(window.db, 'plans');
            const q = firebaseUtils.query(plansRef, firebaseUtils.where('code', '==', 'USER_FREE'), firebaseUtils.limit(1));
            const snapshot = await firebaseUtils.getDocs(q);

            if (snapshot.empty) {
                alert("Plan gratuit non trouv√©. Veuillez d'abord initialiser les plans.");
                return;
            }

            const freePlan = snapshot.docs[0].data();
            const maxCircles = freePlan.limits?.maxCircles || 1;
            const maxMembers = freePlan.limits?.maxMembers || 5;

            const configRef = firebaseUtils.doc(window.db, 'config', 'app_settings');
            await firebaseUtils.updateDoc(configRef, {
                default_max_circles: maxCircles,
                default_max_members: maxMembers,
                last_updated: firebaseUtils.serverTimestamp()
            });

            alert("Limites synchronis√©es avec le Plan Gratuit !");
        }

        // ============ PLANS MANAGEMENT FUNCTIONS ============

        // Populate Default Plans Logic
        async function populateDefaultPlans() {
            if (!confirm("Voulez-vous g√©n√©rer les plans par d√©faut (Gratuit, Starter, Standard, Premium) ?")) return;

            const btn = document.getElementById('btnPopulate');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Initialisation...';
            btn.disabled = true;

            const defaultPlans = [
                { id: 'plan_gratuit', code: 'USER_FREE', type: 'user', name: 'Gratuit', emoji: 'üÜì', status: 'active', isActive: true, isDefault: true, sortOrder: 0, billingPeriod: 'none', prices: { EUR: 0, XOF: 0 }, limits: { maxCircles: 1, maxPotAmount: 50, maxMembers: 5 } },
                { id: 'plan_starter', code: 'USER_STARTER', type: 'user', name: 'Starter', emoji: 'üöÄ', status: 'active', isActive: true, sortOrder: 1, billingPeriod: 'month', prices: { EUR: 1.99, XOF: 1300 }, stripePriceId: 'price_1SnnDPCpguZvNb1UKvVOOhJH', limits: { maxCircles: 3, maxPotAmount: 150, maxMembers: 10 } },
                { id: 'plan_standard', code: 'USER_STANDARD', type: 'user', name: 'Standard', emoji: 'üíé', status: 'active', isActive: true, sortOrder: 2, billingPeriod: 'month', prices: { EUR: 4.99, XOF: 3200 }, stripePriceId: 'price_1SnnMNCpguZvNb1UxajfkrK2', limits: { maxCircles: 10, maxPotAmount: 500, maxMembers: 20 } },
                { id: 'plan_premium', code: 'USER_PREMIUM', type: 'user', name: 'Premium', emoji: 'üëë', status: 'active', isActive: true, sortOrder: 3, billingPeriod: 'month', prices: { EUR: 9.99, XOF: 6500 }, stripePriceId: 'price_1SnnOmCpguZvNb1UXliBvti3', limits: { maxCircles: 50, maxPotAmount: 2000, maxMembers: 100 } }
            ];

            try {
                for (const plan of defaultPlans) {
                    await firebaseUtils.setDoc(firebaseUtils.doc(window.db, 'plans', plan.id), plan);
                }
                alert("üöÄ Plans initialis√©s avec succ√®s !");
                refreshPlans();
            } catch (error) {
                console.error("Error populating plans:", error);
                alert("Erreur lors de l'initialisation : " + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function refreshPlans() {
            const tableBody = document.getElementById('plansTableBody');
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center"><i class="fas fa-spinner fa-spin"></i> Chargement des plans...</td></tr>';

            try {
                const q = firebaseUtils.collection(window.db, 'plans');
                const snapshot = await firebaseUtils.getDocs(q);
                allPlans = [];

                tableBody.innerHTML = '';
                let userCount = 0;
                let merchantCount = 0;
                let enterpriseCount = 0;

                snapshot.forEach(doc => {
                    const plan = { id: doc.id, ...doc.data() };
                    allPlans.push(plan);

                    if (plan.type === 'user') userCount++;
                    if (plan.type === 'merchant') merchantCount++;
                    if (plan.type === 'enterprise') enterpriseCount++;

                    const row = document.createElement('tr');
                    const prices = plan.prices || {};
                    const limits = plan.limits || {};

                    row.innerHTML = `
                        <td>
                            <div style="font-weight:bold">${plan.emoji || ''} ${plan.name}</div>
                            <div style="font-size:10px; color:var(--text-muted)">ID: ${plan.id}</div>
                        </td>
                        <td><span class="status ${plan.type === 'user' ? 'active' : 'pending'}" style="text-transform: capitalize">${plan.type}</span></td>
                        <td>
                            <div style="color:#86efac">${prices.EUR || 0} ‚Ç¨ / mois</div>
                            <div style="font-size:11px; color:#fcd34d">${prices.XOF || 0} FCFA</div>
                        </td>
                        <td>
                            <div>${limits.maxCircles || '‚àû'} cercles</div>
                            <div style="font-size:11px; color:var(--text-muted)">${limits.maxMembers || '‚àû'} membres / pot</div>
                        </td>
                        <td><span class="status ${plan.status === 'active' ? 'active' : 'suspended'}">${plan.status}</span></td>
                        <td>
                            <button class="action-btn view" onclick="openPlanModal('${plan.id}')"><i class="fas fa-edit"></i> Modifier</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                document.getElementById('countUserPlans').textContent = userCount;
                document.getElementById('countMerchantPlans').textContent = merchantCount;
                if (document.getElementById('countEnterprisePlans')) {
                    document.getElementById('countEnterprisePlans').textContent = enterpriseCount;
                }

            } catch (error) {
                console.error('‚ùå Error fetching plans:', error);
                tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:var(--danger)">Erreur de chargement : ${error.message}</td></tr>`;
            }
        }

        window.refreshPlans = refreshPlans;

        function openPlanModal(planId) {
            const plan = planId ? allPlans.find(p => p.id === planId) : {
                id: '',
                name: '',
                emoji: '‚ú®',
                prices: { EUR: 0, XOF: 0 },
                limits: { maxCircles: 1, maxMembers: 10, maxPotAmount: 0 },
                status: 'active',
                code: '',
                sortOrder: 0,
                type: 'user',
                billingPeriod: 'month',
                isActive: true
            };

            document.getElementById('modalTitle').textContent = planId ? `Modifier : ${plan.name}` : "Ajouter un nouveau Plan";
            document.getElementById('editPlanId').value = plan.id || '';
            document.getElementById('editPlanId').disabled = !!planId; // Prevent changing ID on edit
            document.getElementById('editPlanName').value = plan.name || '';
            document.getElementById('editPlanEmoji').value = plan.emoji || '';
            document.getElementById('editPriceEur').value = plan.prices?.EUR || 0;
            document.getElementById('editPriceXof').value = plan.prices?.XOF || 0;
            document.getElementById('editMaxCircles').value = plan.limits?.maxCircles || 0;
            document.getElementById('editMaxMembers').value = plan.limits?.maxMembers || 0;
            document.getElementById('editMaxPot').value = plan.limits?.maxPotAmount || 0;
            document.getElementById('editStripePriceId').value = plan.stripePriceId || '';
            document.getElementById('editPlanStatus').value = plan.status || 'active';

            // New Fields
            document.getElementById('editPlanCode').value = plan.code || '';
            document.getElementById('editSortOrder').value = plan.sortOrder || plan.sort_order || 0;
            document.getElementById('editPlanAudience').value = plan.type || plan.audience || 'user';
            document.getElementById('editBillingPeriod').value = plan.billingPeriod || plan.billing_period || 'month';
            document.getElementById('editIsActive').checked = plan.isActive !== false && plan.is_active !== false;

            // Enterprise/Merchant limits
            document.getElementById('editMaxEmployees').value = plan.limits?.maxEmployees || 0;
            document.getElementById('editMaxProducts').value = plan.limits?.maxProducts || 0;
            toggleSpecialLimits();

            document.getElementById('editPlanModal').style.display = 'flex';
        }

        function toggleSpecialLimits() {
            const audience = document.getElementById('editPlanAudience').value;
            document.querySelector('.staff-limit').style.display = (audience === 'enterprise') ? 'block' : 'none';
            document.querySelector('.product-limit').style.display = (audience === 'merchant') ? 'block' : 'none';
        }

        window.openPlanModal = openPlanModal;

        function closePlanModal() {
            document.getElementById('editPlanModal').style.display = 'none';
        }

        window.closePlanModal = closePlanModal;

        document.getElementById('editPlanForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';
            btn.disabled = true;

            try {
                // Determine if we are creating or updating
                let planId = document.getElementById('editPlanId').value;
                if (!planId && !document.getElementById('editPlanCode').value) {
                    throw new Error("L'ID ou le Code est requis pour cr√©er un plan.");
                }

                // If no ID (creation), use the code as slug ID
                if (!planId) {
                    planId = 'plan_' + document.getElementById('editPlanCode').value.toLowerCase().replace(/[^a-z0-9]/g, '_');
                }

                const planRef = firebaseUtils.doc(window.db, 'plans', planId);
                const updatedData = {
                    name: document.getElementById('editPlanName').value,
                    emoji: document.getElementById('editPlanEmoji').value,
                    code: document.getElementById('editPlanCode').value,
                    type: document.getElementById('editPlanAudience').value,
                    sortOrder: parseInt(document.getElementById('editSortOrder').value),
                    billingPeriod: document.getElementById('editBillingPeriod').value,
                    isActive: document.getElementById('editIsActive').checked,
                    prices: {
                        EUR: parseFloat(document.getElementById('editPriceEur').value),
                        XOF: parseInt(document.getElementById('editPriceXof').value)
                    },
                    limits: {
                        maxCircles: parseInt(document.getElementById('editMaxCircles').value),
                        maxMembers: parseInt(document.getElementById('editMaxMembers').value),
                        maxPotAmount: parseFloat(document.getElementById('editMaxPot').value),
                        maxEmployees: parseInt(document.getElementById('editMaxEmployees').value) || 0,
                        maxProducts: parseInt(document.getElementById('editMaxProducts').value) || 0
                    },
                    stripePriceId: document.getElementById('editStripePriceId').value,
                    status: document.getElementById('editPlanStatus').value,
                    updatedAt: new Date().toISOString()
                };

                await firebaseUtils.updateDoc(planRef, updatedData);

                closePlanModal();
                alert('‚úÖ Plan mis √† jour avec succ√®s !');
                refreshPlans();
            } catch (error) {
                console.error('‚ùå Error updating plan:', error);
                alert('Erreur lors de la mise √† jour : ' + error.message);
            } finally {
                btn.innerHTML = 'ENREGISTRER LES MODIFICATIONS';
                btn.disabled = false;
            }
        });

        // ============ REALTIME DASHBOARD DATA ============

        function initRealtimeListeners() {
            console.log('[DASHBOARD] üöÄ Starting realtime listeners...');

            // 1. Stats & Lists
            fetchOverviewStats();
            fetchUsers();
            fetchCircles();
            fetchMerchants();
            fetchEnterprises();
            fetchAdmins();

            // 2. Realtime Snapshots
            initAuditListener();
            initSupportListener();
            initCampaignsListener();
            initModerationListener();
            initReferralListener();
            initFinanceListeners();
            fetchFinanceStats();

            // 3. Configuration
            refreshPlans();
            initGlobalSettings();

            // 4. Sidebar Badges (Dynamic)
            initSidebarBadges();
        }

        // ============ SIDEBAR BADGES (DYNAMIC) ============
        function initSidebarBadges() {
            console.log('[SIDEBAR] Initializing dynamic badges...');

            // Moderation Badge: Count of pending moderation cases
            const qModeration = firebaseUtils.query(
                firebaseUtils.collection(window.db, 'moderation_cases'),
                firebaseUtils.where('status', '==', 'underReview')
            );
            firebaseUtils.onSnapshot(qModeration, (snapshot) => {
                const badge = document.getElementById('badge-moderation');
                if (badge) badge.textContent = snapshot.size || '0';
            });

            // Reports Badge: Count of unresolved fraud alerts
            const qReports = firebaseUtils.query(
                firebaseUtils.collection(window.db, 'fraud_alerts'),
                firebaseUtils.where('isResolved', '==', false)
            );
            firebaseUtils.onSnapshot(qReports, (snapshot) => {
                const badge = document.getElementById('badge-reports');
                if (badge) badge.textContent = snapshot.size || '0';
            });

            // Support Badge: Count of open support tickets
            const qSupport = firebaseUtils.query(
                firebaseUtils.collection(window.db, 'support_tickets'),
                firebaseUtils.where('status', '==', 'open')
            );
            firebaseUtils.onSnapshot(qSupport, (snapshot) => {
                const badge = document.getElementById('badge-support');
                if (badge) badge.textContent = snapshot.size || '0';
            });

            // Referral Badge: Count of successful referrals (this month)
            const qReferral = firebaseUtils.query(
                firebaseUtils.collection(window.db, 'referrals'),
                firebaseUtils.where('status', '==', 'completed'),
                firebaseUtils.limit(100)
            );
            firebaseUtils.onSnapshot(qReferral, (snapshot) => {
                const badge = document.getElementById('badge-referral');
                if (badge) badge.textContent = snapshot.size || '0';
            }, (error) => {
                // Collection might not exist yet
                const badge = document.getElementById('badge-referral');
                if (badge) badge.textContent = '0';
            });

            // Health Banner: Update based on actual data
            updateHealthBanner();
        }

        async function updateHealthBanner() {
            const statusText = document.getElementById('health-status-text');
            const description = document.getElementById('health-description');
            const uptime = document.getElementById('health-uptime');

            try {
                // Count open alerts (moderation + fraud)
                const qMod = firebaseUtils.query(firebaseUtils.collection(window.db, 'moderation_cases'), firebaseUtils.where('status', '==', 'underReview'));
                const qFraud = firebaseUtils.query(firebaseUtils.collection(window.db, 'fraud_alerts'), firebaseUtils.where('isResolved', '==', false));

                const [modSnap, fraudSnap] = await Promise.all([
                    firebaseUtils.getDocs(qMod),
                    firebaseUtils.getDocs(qFraud)
                ]);

                const totalAlerts = modSnap.size + fraudSnap.size;

                if (totalAlerts === 0) {
                    if (statusText) statusText.textContent = 'Plateforme op√©rationnelle';
                    if (description) description.textContent = 'Tous les services fonctionnent normalement. Aucune alerte.';
                } else {
                    if (statusText) statusText.textContent = 'Plateforme op√©rationnelle';
                    if (description) description.textContent = `Tous les services fonctionnent normalement. ${totalAlerts} alerte(s) √† traiter.`;
                }

                // Uptime is typically from external monitoring, we'll simulate 99.9%+
                if (uptime) uptime.textContent = '99.9%';
            } catch (error) {
                console.error('[HEALTH] Error updating banner:', error);
                if (description) description.textContent = 'Impossible de charger les donn√©es.';
            }
        }

        async function fetchOverviewStats() {
            try {
                // Count Users (Estimate)
                const usersSnap = await firebaseUtils.getCountFromServer(firebaseUtils.collection(window.db, 'users'));
                console.log('[AUDIT] fetchOverviewStats - Total users count:', usersSnap.data().count);
                document.getElementById('stat_users').innerText = usersSnap.data().count;

                // Count Circles
                const circlesSnap = await firebaseUtils.getCountFromServer(firebaseUtils.collection(window.db, 'tontines'));
                document.getElementById('stat_circles').innerText = circlesSnap.data().count;

                // Count Merchants
                const merchantsQ = firebaseUtils.query(firebaseUtils.collection(window.db, 'users'), firebaseUtils.where('role', '==', 'merchant'));
                const merchantsSnap = await firebaseUtils.getCountFromServer(merchantsQ);
                document.getElementById('stat_merchants').innerText = merchantsSnap.data().count;

                // Total Volume
                const transSnap = await firebaseUtils.getDocs(firebaseUtils.collection(window.db, 'transactions'));
                let total = 0;
                transSnap.forEach(d => {
                    const data = d.data();
                    if (data.status === 'success') total += parseFloat(data.amount) || 0;
                });
                document.getElementById('stat_volume').innerText = total.toLocaleString();
            } catch (e) {
                console.error("Error fetching stats:", e);
                document.getElementById('stat_users').innerText = "-";
                document.getElementById('stat_circles').innerText = "-";
                document.getElementById('stat_merchants').innerText = "-";
            }
        }

        // --- USERS ---
        async function fetchUsers() {
            const tableBody = document.getElementById('usersTableBody');
            try {
                const q = firebaseUtils.query(firebaseUtils.collection(window.db, 'users'), firebaseUtils.limit(50));
                const snapshot = await firebaseUtils.getDocs(q);
                console.log('[AUDIT] fetchUsers - snapshot size:', snapshot.size);

                if (snapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center">Aucun utilisateur trouv√©.</td></tr>';
                    return;
                }

                tableBody.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = document.createElement('tr');
                    const statusClass = (data.status === 'suspended') ? 'suspended' : 'active';
                    const name = data.fullName || data.businessName || data.displayName || 'Sans nom';

                    row.innerHTML = `
                        <td>
                            <div style="font-weight:bold">${name}</div>
                            <div style="font-size:10px; color:var(--text-muted)">${data.email || 'Pas d\'email'}</div>
                            <div style="font-size:9px; color:rgba(255,255,255,0.2)">ID: ${doc.id}</div>
                        </td>
                        <td><span class="status ${statusClass}">${data.status || 'Actif'}</span></td>
                        <td>${data.role || 'Particulier'}</td>
                        <td>${data.trustScore || '-'}%</td>
                        <td>${data.stats?.activeCircles || 0}</td>
                        <td>
                            <button class="action-btn view" onclick="showDocument('users', '${doc.id}')">Voir</button>
                            <button class="action-btn suspend" onclick="toggleUserStatus('${doc.id}', '${data.status}')">${data.status === 'suspended' ? 'R√©activer' : 'Suspendre'}</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (e) {
                console.error("Error fetching users:", e);
                tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:var(--danger)">Erreur: ${e.message}</td></tr>`;
            }
        }

        async function searchUsers() {
            const input = document.getElementById('userSearchInput').value.trim();
            console.log('[AUDIT] Searching for:', input);
            if (!input) {
                fetchUsers();
                return;
            }

            const tableBody = document.getElementById('usersTableBody');
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center"><i class="fas fa-spinner fa-spin"></i> Recherche...</td></tr>';

            try {
                // Try searching by exact UID first
                const docRef = firebaseUtils.doc(window.db, 'users', input);
                const docSnap = await firebaseUtils.getDoc(docRef);

                if (docSnap.exists()) {
                    console.log('[AUDIT] User found by UID:', docSnap.id);
                    tableBody.innerHTML = '';
                    renderUserRow(docSnap, tableBody);
                    return;
                }

                // Or searching by exact email
                const qEmail = firebaseUtils.query(firebaseUtils.collection(window.db, 'users'), firebaseUtils.where('email', '==', input), firebaseUtils.limit(5));
                const snapEmail = await firebaseUtils.getDocs(qEmail);

                if (!snapEmail.empty) {
                    console.log('[AUDIT] Users found by email:', snapEmail.size);
                    tableBody.innerHTML = '';
                    snapEmail.forEach(d => renderUserRow(d, tableBody));
                    return;
                }

                // Fallback: simple text search (not ideal in Firestore without indexing, but we'll try basic filter)
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center">Aucun r√©sultat exact pour "' + input + '". Essayez l\'UID ou l\'email exact.</td></tr>';
            } catch (e) {
                console.error("Search error:", e);
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:var(--danger)">Erreur de recherche.</td></tr>';
            }
        }

        async function promoteToAdmin(uid, email, currentRole) {
            if (currentRole === 'admin' || currentRole === 'super_admin') {
                alert('Cet utilisateur est d√©j√† administrateur.');
                return;
            }

            if (!confirm(`Voulez-vous vraiment promouvoir ${email || uid} au rang d'Administrateur ?\n\nCela lui donnera un acc√®s complet au Back Office.`)) {
                return;
            }

            try {
                const setUserRole = firebaseUtils.httpsCallable(window.functions, 'setUserRole');
                const result = await setUserRole({ targetUid: uid, role: 'admin' });

                if (result.data.success) {
                    alert('Promotion r√©ussie ! L\'utilisateur est maintenant Admin.');
                    fetchUsers();
                    fetchAdmins();
                } else {
                    alert('Erreur: ' + result.data.message);
                }
            } catch (error) {
                console.error('Promotion error:', error);
                alert('√âchec de la promotion: ' + error.message);
            }
        }

        async function addAdminManual() {
            const input = prompt("Entrez l'UID ou l'Email exact de l'utilisateur √† promouvoir admin :");
            if (!input) return;

            // Simple check: if it contains @, it's likely an email, otherwise assume UID
            if (input.includes('@')) {
                // Search by email first to get UID
                try {
                    const q = firebaseUtils.query(firebaseUtils.collection(window.db, 'users'), firebaseUtils.where('email', '==', input.trim()), firebaseUtils.limit(1));
                    const snap = await firebaseUtils.getDocs(q);
                    if (snap.empty) {
                        alert("Aucun utilisateur trouv√© avec cet email.");
                        return;
                    }
                    const userDoc = snap.docs[0];
                    promoteToAdmin(userDoc.id, userDoc.data().email, userDoc.data().role);
                } catch (e) {
                    alert("Erreur de recherche: " + e.message);
                }
            } else {
                // Assume UID
                promoteToAdmin(input.trim(), input.trim(), 'unknown');
            }
        }

        function renderUserRow(doc, tableBody) {
            const data = doc.data();
            const row = document.createElement('tr');
            const statusClass = (data.status === 'suspended') ? 'suspended' : 'active';
            const name = data.fullName || data.businessName || data.displayName || 'Sans nom';
            const role = data.role || 'Particulier';

            row.innerHTML = `
                <td>
                    <div style="font-weight:bold">${name}</div>
                    <div style="font-size:10px; color:var(--text-muted)">${data.email || 'Pas d\'email'}</div>
                    <div style="font-size:9px; color:rgba(255,255,255,0.2)">ID: ${doc.id}</div>
                </td>
                <td><span class="status ${statusClass}">${data.status || 'Actif'}</span></td>
                <td>${role}</td>
                <td>${data.honorScore || '-'}%</td>
                <td>${data.stats?.activeCircles || 0}</td>
                <td>
                    <button class="action-btn view" onclick="showDocument('users', '${doc.id}')">Voir</button>
                    <button class="action-btn suspend" onclick="toggleUserStatus('${doc.id}', '${data.status}')">${data.status === 'suspended' ? 'R√©activer' : 'Suspendre'}</button>
                    ${role === 'admin' || role === 'super_admin' ? '' : `<button class="action-btn approve" onclick="promoteToAdmin('${doc.id}', '${data.email}', '${role}')">Passer Admin</button>`}
                </td>
            `;
            tableBody.appendChild(row);
        }

        async function toggleUserStatus(uid, currentStatus) {
            const newStatus = (currentStatus === 'suspended') ? 'active' : 'suspended';
            if (!confirm(`Voulez-vous vraiment passer l'utilisateur en statut: ${newStatus} ?`)) return;

            try {
                const userRef = firebaseUtils.doc(window.db, 'users', uid);
                await firebaseUtils.updateDoc(userRef, { status: newStatus });
                alert('Statut mis √† jour !');
                fetchUsers();
            } catch (e) {
                alert('Erreur: ' + e.message);
            }
        }

        // --- CIRCLES ---
        async function fetchCircles() {
            const tableBody = document.getElementById('circlesTableBody');
            try {
                const q = firebaseUtils.query(firebaseUtils.collection(window.db, 'tontines'), firebaseUtils.limit(50));
                const snapshot = await firebaseUtils.getDocs(q);

                if (snapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center">Aucun cercle trouv√©.</td></tr>';
                    return;
                }

                tableBody.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = document.createElement('tr');
                    const statusClass = (data.status === 'active') ? 'active' : 'pending';

                    row.innerHTML = `
                        <td>
                            <div style="font-weight:bold">${data.name || 'Cercle sans nom'}</div>
                            <div style="font-size:10px; color:var(--text-muted)">ID: ${doc.id.substring(0, 8)}...</div>
                        </td>
                        <td>${data.type || 'Standard'}</td>
                        <td>${data.members?.length || 0} / ${data.maxMembers || '?'}</td>
                        <td>${data.contributionAmount || 0} ${data.currency || 'FCFA'}</td>
                        <td><i class="fab fa-stripe" style="color: #635bff;"></i> Stripe</td>
                        <td><span class="status ${statusClass}">${data.status || 'Inconnu'}</span></td>
                        <td>
                            <button class="action-btn view" onclick="showDocument('tontines', '${doc.id}')">D√©tails</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (e) {
                tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:var(--danger)">Erreur: ${e.message}</td></tr>`;
            }
        }

        // --- MERCHANTS ---
        async function fetchMerchants() {
            const tableBody = document.getElementById('merchantsTableBody');
            try {
                const q = firebaseUtils.query(firebaseUtils.collection(window.db, 'users'), firebaseUtils.where('role', '==', 'merchant'), firebaseUtils.limit(50));
                const snapshot = await firebaseUtils.getDocs(q);
                console.log('[AUDIT] fetchMerchants - snapshot size:', snapshot.size);

                // Update Stats Cards
                if (document.getElementById('merchant-stat-active')) {
                    document.getElementById('merchant-stat-active').innerText = snapshot.size;
                }

                if (snapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center">Aucun marchand trouv√©.</td></tr>';
                    return;
                }

                tableBody.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div style="font-weight:bold">${data.businessName || data.displayName || 'Marchand'}</div>
                        </td>
                        <td>${data.displayName || '-'}</td>
                        <td>${data.productsCount || 0}</td>
                        <td>${data.iban ? '<i class="fas fa-check-circle" style="color: var(--success);"></i>' : '<i class="fas fa-times-circle" style="color: var(--danger);"></i>'}</td>
                        <td>0</td>
                        <td><span class="status active">Actif</span></td>
                        <td>
                            <button class="action-btn view" onclick="showDocument('users', '${doc.id}')">D√©tails</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (e) {
                tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:var(--danger)">Erreur: ${e.message}</td></tr>`;
            }
        }

        // --- ENTERPRISES ---
        async function fetchEnterprises() {
            const tableBody = document.getElementById('enterprisesTableBody');
            try {
                const q = firebaseUtils.query(firebaseUtils.collection(window.db, 'users'), firebaseUtils.where('role', '==', 'enterprise'), firebaseUtils.limit(50));
                const snapshot = await firebaseUtils.getDocs(q);
                console.log('[AUDIT] fetchEnterprises - snapshot size:', snapshot.size);

                // Update Stats Cards
                if (document.getElementById('enterprise-stat-count')) {
                    document.getElementById('enterprise-stat-count').innerText = snapshot.size;
                }

                if (snapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center">Aucune entreprise trouv√©e.</td></tr>';
                    return;
                }

                tableBody.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div style="font-weight:bold">${data.companyName || data.displayName || 'Entreprise'}</div>
                        </td>
                        <td><span class="status active">Enterprise</span></td>
                        <td>${data.employeesCount || 0}</td>
                        <td>${data.activeTontines || 0}</td>
                        <td>${data.contributionTotal || 0} FCFA</td>
                        <td>-</td>
                        <td>
                            <button class="action-btn view" onclick="showDocument('users', '${doc.id}')">D√©tails</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (e) {
                tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:var(--danger)">Erreur: ${e.message}</td></tr>`;
            }
        }

        // --- ADMINS ---
        async function fetchAdmins() {
            const tableBody = document.getElementById('adminsTableBody');
            try {
                const q = firebaseUtils.query(firebaseUtils.collection(window.db, 'users'), firebaseUtils.where('role', 'in', ['admin', 'super_admin']), firebaseUtils.limit(20));
                const snapshot = await firebaseUtils.getDocs(q);
                console.log('[AUDIT] fetchAdmins - snapshot size:', snapshot.size);

                if (snapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center">Aucun autre admin trouv√©.</td></tr>';
                    return;
                }

                tableBody.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const row = document.createElement('tr');
                    const statusClass = (data.status === 'suspended') ? 'suspended' : 'active';
                    const name = data.displayName || data.fullName || 'Admin';

                    row.innerHTML = `
                        <td>${name}</td>
                        <td>${data.email}</td>
                        <td><span class="status active">${data.role}</span></td>
                        <td><i class="fas fa-check-circle" style="color: var(--success);"></i></td>
                        <td><span class="status active">Actif</span></td>
                        <td>-</td>
                        <td><button class="action-btn view" onclick="showDocument('users', '${doc.id}')">D√©tails</button></td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (e) {
                tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:var(--danger)">Erreur: ${e.message}</td></tr>`;
            }
        }

        // --- FINANCE ---
        async function fetchFinanceStats() {
            try {
                const transactionsSnap = await firebaseUtils.getDocs(firebaseUtils.collection(window.db, 'transactions'));
                let totalVolume = 0;
                let platformRevenue = 0;
                let enterpriseRevenue = 0;
                let merchantRevenue = 0;
                let capturedCount = 0;
                let authorizedCount = 0;
                let rejectedCount = 0;
                let pendingCount = 0;

                let promotionalTotal = 0;
                let promotionalCount = 0;

                transactionsSnap.forEach(doc => {
                    const data = doc.data();
                    const amount = parseFloat(data.amount) || 0;

                    if (data.status === 'success') {
                        totalVolume += amount;
                        capturedCount++;

                        // Plateforme Revenue Mapping
                        if (['subscription', 'boost', 'premium'].includes(data.type)) {
                            platformRevenue += amount;
                            if (data.type === 'subscription') enterpriseRevenue += amount;
                            if (data.type === 'boost') merchantRevenue += amount;
                        }

                        // Promotional Tracking
                        if (data.type === 'referral' || data.type === 'cashback') {
                            promotionalTotal += amount;
                            promotionalCount++;
                        }
                    } else if (data.status === 'failed') {
                        rejectedCount++;
                    } else if (data.status === 'pending') {
                        pendingCount++;
                    } else if (data.status === 'authorized') {
                        authorizedCount++;
                    }
                });

                // Update UI
                if (document.getElementById('stat_revenue_total')) document.getElementById('stat_revenue_total').innerText = platformRevenue.toLocaleString() + ' F';
                if (document.getElementById('stat_revenue_enterprise')) document.getElementById('stat_revenue_enterprise').innerText = enterpriseRevenue.toLocaleString() + ' F';
                if (document.getElementById('stat_revenue_merchant')) document.getElementById('stat_revenue_merchant').innerText = merchantRevenue.toLocaleString() + ' F';

                // Taxes
                const tva = platformRevenue * 0.18;
                const ht = platformRevenue - tva;
                if (document.getElementById('stat_revenue_details')) {
                    document.getElementById('stat_revenue_details').innerText = `HT: ${Math.round(ht).toLocaleString()} F | TVA: ${Math.round(tva).toLocaleString()} F`;
                }

                // Volume Stats
                if (document.getElementById('stat_volume_captured')) document.getElementById('stat_volume_captured').innerText = capturedCount;
                if (document.getElementById('stat_volume_authorized')) document.getElementById('stat_volume_authorized').innerText = authorizedCount;
                if (document.getElementById('stat_volume_rejected')) document.getElementById('stat_volume_rejected').innerText = rejectedCount;
                if (document.getElementById('stat_volume_pending')) document.getElementById('stat_volume_pending').innerText = pendingCount;

                // Promotional Stats
                if (document.getElementById('stat_promotional_total')) document.getElementById('stat_promotional_total').innerText = promotionalTotal.toLocaleString() + ' F';
                if (document.getElementById('stat_promotional_count')) document.getElementById('stat_promotional_count').innerText = `Budget marketing & abondements (${promotionalCount} events)`;

            } catch (e) {
                console.error("[FINANCE] Error updating stats:", e);
            }
        }

        function initFinanceListeners() {
            const tbody = document.getElementById('financeTableBody');
            if (!tbody) return;

            const q = firebaseUtils.query(
                firebaseUtils.collection(window.db, 'transactions'),
                firebaseUtils.orderBy('date', 'desc'),
                firebaseUtils.limit(20)
            );

            firebaseUtils.onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:var(--text-muted); padding:20px;">Aucune transaction r√©cente</td></tr>';
                    return;
                }
                tbody.innerHTML = '';
                snapshot.forEach(doc => {
                    const d = doc.data();
                    const date = d.date ? (d.date.toDate ? d.date.toDate() : new Date(d.date)) : new Date();
                    const statusClass = d.status === 'success' ? 'active' : (d.status === 'failed' ? 'suspended' : 'pending');
                    const statusText = d.status === 'success' ? 'R√©ussi' : (d.status === 'failed' ? '√âchou√©' : 'Attente');

                    const row = `<tr>
                        <td>${date.toLocaleString('fr-FR')}</td>
                        <td>${d.type || 'Transaction'}</td>
                        <td style="font-weight:bold">${d.amount} ${d.currency || 'F'}</td>
                        <td>${d.userName || d.userId?.substring(0, 8) || 'Syst√®me'}</td>
                        <td><code>${doc.id.substring(0, 8)}</code></td>
                        <td><span class="status ${statusClass}">${statusText}</span></td>
                    </tr>`;
                    tbody.innerHTML += row;
                });

                // Refresh top level stats
                fetchFinanceStats();
            });
        }

        function initAuditListener() {
            const tbody = document.getElementById('auditTableBody');
            if (!tbody) return;

            const q = firebaseUtils.query(
                firebaseUtils.collection(window.db, 'audit_logs'),
                firebaseUtils.orderBy('timestamp', 'desc'),
                firebaseUtils.limit(10)
            );

            firebaseUtils.onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:var(--text-muted); padding:20px;">Aucun audit log r√©cent</td></tr>';
                    return;
                }
                tbody.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.timestamp ? (data.timestamp.toDate ? data.timestamp.toDate() : new Date(data.timestamp)) : new Date();
                    const row = `<tr>
                        <td>${date.toLocaleString('fr-FR')}</td>
                        <td>${data.performedBy || 'Syst√®me'}</td>
                        <td style="font-weight:500">${data.action || 'Action Inconnue'}</td>
                        <td style="color:var(--text-muted)">${data.details || '-'}</td>
                        <td style="font-family:monospace; font-size:11px">${data.ip || 'N/A'}</td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            });
        }

        function initSupportListener() {
            const tbody = document.getElementById('supportTableBody');
            if (!tbody) return;

            const q = firebaseUtils.query(
                firebaseUtils.collection(window.db, 'support_tickets'),
                firebaseUtils.where('status', '==', 'open'),
                firebaseUtils.limit(20)
            );

            firebaseUtils.onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:var(--text-muted); padding:20px;">üéâ Aucun ticket ouvert</td></tr>';
                    return;
                }
                tbody.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const priorityColor = data.priority === 'high' ? 'var(--danger)' : (data.priority === 'medium' ? 'var(--warning)' : 'var(--success)');
                    let dateStr = '-';
                    if (data.updatedAt) {
                        dateStr = data.updatedAt.toDate ? data.updatedAt.toDate().toLocaleDateString() : new Date(data.updatedAt).toLocaleDateString();
                    } else if (data.createdAt) {
                        dateStr = data.createdAt.toDate ? data.createdAt.toDate().toLocaleDateString() : new Date(data.createdAt).toLocaleDateString();
                    }

                    const row = `<tr>
                        <td>#${doc.id.substring(0, 6)}</td>
                        <td>${data.userName || 'Utilisateur'}</td>
                        <td>${data.category || 'G√©n√©ral'}</td>
                        <td>${data.subject || 'Sujet'}</td>
                        <td><span class="status" style="color:${priorityColor}; background:rgba(255,255,255,0.05)">${data.priority || 'Normal'}</span></td>
                        <td>${dateStr}</td>
                        <td><button class="action-btn view" onclick="openTicket('${doc.id}')">Voir</button></td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            }, (error) => {
                console.error('[ERROR] Support listener failed:', error);
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:var(--danger)">Erreur de chargement: ${error.message}</td></tr>`;
            });
        }

        let supportChatUnsub = null;

        async function openTicket(ticketId) {
            const modal = document.getElementById('supportTicketModal');
            const title = document.getElementById('supportModalTitle');
            const details = document.getElementById('supportTicketDetails');
            const history = document.getElementById('supportChatHistory');
            const statusBadge = document.getElementById('supportTicketStatusBadge');
            const categoryText = document.getElementById('supportTicketCategory');

            document.getElementById('currentTicketId').value = ticketId;
            document.getElementById('supportReplyText').value = '';

            modal.style.display = 'flex';
            history.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 40px;"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>';

            try {
                const ticketRef = firebaseUtils.doc(window.db, 'support_tickets', ticketId);
                const ticketSnap = await firebaseUtils.getDoc(ticketRef);

                if (ticketSnap.exists()) {
                    const data = ticketSnap.data();
                    title.innerText = `#${ticketId.substring(0, 8)}`;
                    details.innerHTML = `<strong>Utilisateur:</strong> ${data.userName} (${data.userEmail || 'N/A'}) | <strong>Sujet:</strong> ${data.subject}`;
                    categoryText.innerText = `Cat√©gorie: ${data.category || 'Standard'}`;
                    statusBadge.innerText = (data.status || 'open').toUpperCase();
                    statusBadge.style.background = data.status === 'open' ? 'rgba(34,197,94,0.1)' : 'rgba(148,163,184,0.1)';
                    statusBadge.style.color = data.status === 'open' ? 'var(--success)' : 'var(--text-muted)';
                }

                if (supportChatUnsub) supportChatUnsub();

                const q = firebaseUtils.query(
                    firebaseUtils.collection(window.db, 'support_tickets', ticketId, 'messages'),
                    firebaseUtils.orderBy('timestamp', 'asc')
                );

                supportChatUnsub = firebaseUtils.onSnapshot(q, (snapshot) => {
                    history.innerHTML = '';
                    if (snapshot.empty) {
                        history.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">Le message initial appara√Ætra ici.</div>';
                    }
                    snapshot.forEach(doc => {
                        const msg = doc.data();
                        const isStaff = msg.isStaff === true || msg.senderId === 'admin';
                        const time = msg.timestamp ? (msg.timestamp.toDate ? msg.timestamp.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : new Date(msg.timestamp).toLocaleTimeString()) : '--:--';

                        const bubble = document.createElement('div');
                        bubble.style.display = 'flex';
                        bubble.style.flexDirection = 'column';
                        bubble.style.alignItems = isStaff ? 'flex-end' : 'flex-start';
                        bubble.style.marginBottom = '12px';

                        bubble.innerHTML = `
                            <div style="max-width: 85%; padding: 12px 16px; border-radius: 12px; font-size: 14px; line-height: 1.4;
                                background: ${isStaff ? 'var(--accent)' : 'rgba(255,255,255,0.08)'}; 
                                color: white;
                                border-bottom-${isStaff ? 'right' : 'left'}-radius: 2px;
                                box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                ${msg.text}
                                <div style="font-size: 10px; opacity: 0.5; margin-top: 6px; text-align: right;">${time}</div>
                            </div>
                        `;
                        history.appendChild(bubble);
                    });
                    history.scrollTop = history.scrollHeight;
                });
            } catch (e) {
                console.error('[SUPPORT] Error:', e);
                history.innerHTML = `<div style="color: var(--danger); text-align: center; padding: 20px;">Erreur: ${e.message}</div>`;
            }
        }

        function closeSupportModal() {
            document.getElementById('supportTicketModal').style.display = 'none';
            if (supportChatUnsub) {
                supportChatUnsub();
                supportChatUnsub = null;
            }
        }

        async function sendSupportReply() {
            const ticketId = document.getElementById('currentTicketId').value;
            const text = document.getElementById('supportReplyText').value.trim();
            if (!text || !ticketId) return;

            const btn = document.querySelector('#supportTicketModal .btn-login');
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                await firebaseUtils.addDoc(firebaseUtils.collection(window.db, 'support_tickets', ticketId, 'messages'), {
                    text: text,
                    senderId: 'admin',
                    senderName: 'Support Tontetic',
                    isStaff: true,
                    timestamp: firebaseUtils.serverTimestamp()
                });

                await firebaseUtils.updateDoc(firebaseUtils.doc(window.db, 'support_tickets', ticketId), {
                    updatedAt: firebaseUtils.serverTimestamp(),
                    lastMessage: text
                });

                document.getElementById('supportReplyText').value = '';
            } catch (e) {
                alert('Erreur d\'envoi: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        }

        async function resolveTicket() {
            const ticketId = document.getElementById('currentTicketId').value;
            if (!ticketId || !confirm('Voulez-vous vraiment marquer ce ticket comme R√âSOLU ?')) return;

            try {
                await firebaseUtils.updateDoc(firebaseUtils.doc(window.db, 'support_tickets', ticketId), {
                    status: 'resolved',
                    resolvedAt: firebaseUtils.serverTimestamp()
                });
                closeSupportModal();
                alert('‚úÖ Ticket ferm√© avec succ√®s.');
            } catch (e) {
                alert('Erreur: ' + e.message);
            }
        }

        async function showDocument(collectionName, docId) {
            const modal = document.getElementById('documentDetailModal');
            const content = document.getElementById('documentDetailContent');

            modal.style.display = 'flex';
            content.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Chargement...';

            try {
                const docRef = firebaseUtils.doc(window.db, collectionName, docId);
                const docSnap = await firebaseUtils.getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    content.innerHTML = '<pre style="white-space: pre-wrap; word-wrap: break-word;">' +
                        JSON.stringify(data, (key, value) => {
                            if (value && value.toDate) return value.toDate().toLocaleString();
                            return value;
                        }, 2) + '</pre>';
                } else {
                    content.innerHTML = 'Document non trouv√©.';
                }
            } catch (e) {
                content.innerHTML = 'Erreur: ' + e.message;
            }
        }

        function closeDetailModal() {
            document.getElementById('documentDetailModal').style.display = 'none';
        }

        async function examineModeration(id) {
            const docRef = firebaseUtils.doc(window.db, 'moderation_cases', id);
            const docSnap = await firebaseUtils.getDoc(docRef);
            if (!docSnap.exists()) {
                // Try fraud alerts
                const fraudRef = firebaseUtils.doc(window.db, 'fraud_alerts', id);
                const fraudSnap = await firebaseUtils.getDoc(fraudRef);
                if (fraudSnap.exists()) {
                    showDocument('fraud_alerts', id);
                } else {
                    alert('Cas non trouv√©.');
                }
                return;
            }
            showDocument('moderation_cases', id);
        }

        function useSupportTemplate(text) {
            const textarea = document.getElementById('supportReplyText');
            if (textarea) {
                textarea.value = text + "\n";
                textarea.focus();
            }
        }

        function initModerationListener() {
            const tableBody = document.getElementById('moderationTableBody');

            // 1. Snapshot for "√Ä valider" (Under Review)
            const qPending = firebaseUtils.query(
                firebaseUtils.collection(window.db, 'moderation_cases'),
                firebaseUtils.where('status', '==', 'underReview')
            );

            firebaseUtils.onSnapshot(qPending, (snapshot) => {
                const count = snapshot.size;
                const btn = document.getElementById('tab-moderation-pending');
                if (btn) btn.innerText = `√Ä valider (${count})`;

                // If it's the active tab, refresh table
                if (btn && btn.classList.contains('active')) {
                    renderModerationTable(snapshot);
                }
            });

            // 2. Snapshot for "Signal√©s" (Fraud Alerts / Reports)
            const qFlagged = firebaseUtils.query(
                firebaseUtils.collection(window.db, 'fraud_alerts'),
                firebaseUtils.where('isResolved', '==', false)
            );

            firebaseUtils.onSnapshot(qFlagged, (snapshot) => {
                const count = snapshot.size;
                const btn = document.getElementById('tab-moderation-flagged');
                if (btn) btn.innerText = `Signal√©s (${count})`;
            });
        }

        function renderModerationTable(snapshot) {
            const tableBody = document.getElementById('moderationTableBody');
            if (!tableBody) return;

            if (snapshot.empty) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:var(--text-muted); padding:20px;">Aucun contenu en attente de mod√©ration</td></tr>';
                return;
            }

            tableBody.innerHTML = '';
            snapshot.forEach(doc => {
                const data = doc.data();
                const date = data.suspendedAt ? (data.suspendedAt.toDate ? data.suspendedAt.toDate() : new Date(data.suspendedAt)) : new Date();
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div style="font-weight:bold">${data.contentTitle || 'Contenu sans titre'}</div>
                        <div style="font-size:10px; color:var(--text-muted)">ID: ${doc.id.substring(0, 8)}...</div>
                    </td>
                    <td>${data.merchantName || 'Inconnu'}</td>
                    <td><span class="status pending">${data.status || 'En attente'}</span></td>
                    <td>${date.toLocaleDateString()}</td>
                    <td>
                        <button class="action-btn view" onclick="examineModeration('${doc.id}')">Examiner</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function switchModerationTab(tab) {
            // Update UI buttons
            const tabs = ['pending', 'flagged', 'suspended', 'history'];
            tabs.forEach(t => {
                const btn = document.getElementById('tab-moderation-' + t);
                if (btn) btn.classList.remove('active');
            });
            const activeBtn = document.getElementById('tab-moderation-' + tab);
            if (activeBtn) activeBtn.classList.add('active');

            // Re-fetch data for selected tab (simplified for now, triggering listener-based render)
            // In a full implementation, each tab would have its own query
        }

        // ============ CAMPAIGN MODAL FUNCTIONS ============

        function openCampaignModal() {
            document.getElementById('campaignModal').style.display = 'flex';
            document.getElementById('campaign_title').value = '';
            document.getElementById('campaign_body').value = '';
            document.getElementById('campaign_type').value = 'push';
            document.getElementById('campaign_target').value = 'all';
            document.getElementById('campaign_schedule').checked = false;
            document.getElementById('campaign_scheduled_date').style.display = 'none';

            // Toggle scheduled date visibility
            document.getElementById('campaign_schedule').onchange = function () {
                document.getElementById('campaign_scheduled_date').style.display = this.checked ? 'block' : 'none';
            };
        }

        function closeCampaignModal() {
            document.getElementById('campaignModal').style.display = 'none';
        }

        async function sendCampaign() {
            const title = document.getElementById('campaign_title').value.trim();
            const body = document.getElementById('campaign_body').value.trim();
            const type = document.getElementById('campaign_type').value;
            const target = document.getElementById('campaign_target').value;
            const isScheduled = document.getElementById('campaign_schedule').checked;
            const scheduledDate = document.getElementById('campaign_scheduled_date').value;

            if (!title || !body) {
                alert('Veuillez remplir le titre et le message.');
                return;
            }

            try {
                const campaignData = {
                    title: title,
                    body: body,
                    type: type,
                    target: target,
                    status: isScheduled ? 'scheduled' : 'sent',
                    scheduledAt: isScheduled && scheduledDate ? new Date(scheduledDate) : null,
                    createdAt: firebaseUtils.serverTimestamp(),
                    sentAt: isScheduled ? null : firebaseUtils.serverTimestamp(),
                    createdBy: window.currentAdminId || 'admin'
                };

                await firebaseUtils.addDoc(
                    firebaseUtils.collection(window.db, 'broadcasts'),
                    campaignData
                );

                closeCampaignModal();
                alert('‚úÖ Campagne ' + (isScheduled ? 'programm√©e' : 'envoy√©e') + ' avec succ√®s !');
                console.log('[CAMPAIGNS] Created campaign:', title);
            } catch (error) {
                console.error('[CAMPAIGNS] Error creating campaign:', error);
                alert('‚ùå Erreur: ' + error.message);
            }
        }

        async function saveCampaignDraft() {
            const title = document.getElementById('campaign_title').value.trim() || 'Brouillon sans titre';
            const body = document.getElementById('campaign_body').value.trim();
            const type = document.getElementById('campaign_type').value;
            const target = document.getElementById('campaign_target').value;

            try {
                await firebaseUtils.addDoc(
                    firebaseUtils.collection(window.db, 'broadcasts'),
                    {
                        title: title,
                        body: body,
                        type: type,
                        target: target,
                        status: 'draft',
                        createdAt: firebaseUtils.serverTimestamp(),
                        createdBy: window.currentAdminId || 'admin'
                    }
                );

                closeCampaignModal();
                alert('‚úÖ Brouillon sauvegard√© !');
            } catch (error) {
                console.error('[CAMPAIGNS] Error saving draft:', error);
                alert('‚ùå Erreur: ' + error.message);
            }
        }

        // ============ REFERRAL CAMPAIGN MODAL FUNCTIONS ============

        function openReferralCampaignModal() {
            document.getElementById('referralCampaignModal').style.display = 'flex';
            document.getElementById('ref_campaign_name').value = '';
            document.getElementById('ref_subscription_type').value = 'starter';
            document.getElementById('ref_reward_months').value = '3';
            document.getElementById('ref_reward_type').value = 'both';
            document.getElementById('ref_start_date').value = new Date().toISOString().split('T')[0];
            document.getElementById('ref_end_date').value = '';
            document.getElementById('ref_max_sponsors').value = '100';
            document.getElementById('ref_max_referees_per_sponsor').value = '5';
            document.getElementById('ref_condition').value = 'join_circle';
            document.getElementById('ref_visible_in_app').checked = true;
        }

        function closeReferralCampaignModal() {
            document.getElementById('referralCampaignModal').style.display = 'none';
        }

        async function createReferralCampaign() {
            const name = document.getElementById('ref_campaign_name').value.trim();
            const subscriptionType = document.getElementById('ref_subscription_type').value;
            const rewardMonths = parseInt(document.getElementById('ref_reward_months').value) || 3;
            const rewardType = document.getElementById('ref_reward_type').value;
            const startDate = document.getElementById('ref_start_date').value;
            const endDate = document.getElementById('ref_end_date').value;
            const maxSponsors = parseInt(document.getElementById('ref_max_sponsors').value) || 100;
            const maxRefereesPerSponsor = parseInt(document.getElementById('ref_max_referees_per_sponsor').value) || 5;
            const condition = document.getElementById('ref_condition').value;
            const visibleInApp = document.getElementById('ref_visible_in_app').checked;

            if (!name) {
                alert('Veuillez entrer un nom de campagne.');
                return;
            }

            // Calculate estimated cost (for display)
            const priceMap = { starter: 9.99, pro: 19.99, enterprise: 49.99 };
            const pricePerMonth = priceMap[subscriptionType] || 9.99;
            const maxCost = maxSponsors * maxRefereesPerSponsor * rewardMonths * pricePerMonth;

            try {
                await firebaseUtils.addDoc(
                    firebaseUtils.collection(window.db, 'referral_campaigns'),
                    {
                        name: name,
                        subscriptionType: subscriptionType, // starter, pro, enterprise
                        rewardMonths: rewardMonths,
                        rewardType: rewardType, // both, sponsor, referee
                        startDate: startDate ? new Date(startDate) : new Date(),
                        endDate: endDate ? new Date(endDate) : null,
                        maxSponsors: maxSponsors,
                        maxRefereesPerSponsor: maxRefereesPerSponsor,
                        condition: condition,
                        visibleInApp: visibleInApp,
                        sponsorsCount: 0,
                        referralsCount: 0,
                        estimatedMaxCostEuros: maxCost,
                        status: visibleInApp ? 'active' : 'inactive',
                        createdAt: firebaseUtils.serverTimestamp(),
                        createdBy: window.currentAdminId || 'admin'
                    }
                );

                closeReferralCampaignModal();
                alert(`‚úÖ Campagne cr√©√©e !\n\nCo√ªt max estim√©: ${maxCost.toFixed(2)}‚Ç¨`);
                console.log('[REFERRAL] Created campaign:', name);

                // Refresh referral data
                initReferralListener();
            } catch (error) {
                console.error('[REFERRAL] Error creating campaign:', error);
                alert('‚ùå Erreur: ' + error.message);
            }
        }

        // ============ REFERRAL LISTENER ============

        function initReferralListener() {
            // Listen to referral_campaigns
            const campaignsQ = firebaseUtils.query(
                firebaseUtils.collection(window.db, 'referral_campaigns'),
                firebaseUtils.orderBy('createdAt', 'desc'),
                firebaseUtils.limit(10)
            );

            firebaseUtils.onSnapshot(campaignsQ, (snapshot) => {
                const tbody = document.querySelector('#referral table tbody');
                if (!tbody) return;

                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px; color:var(--text-muted);">Aucune campagne de parrainage active.</td></tr>';
                    return;
                }

                tbody.innerHTML = '';
                snapshot.forEach(doc => {
                    const d = doc.data();
                    const startDate = d.startDate ? (d.startDate.toDate ? d.startDate.toDate().toLocaleDateString() : new Date(d.startDate).toLocaleDateString()) : '--';
                    const endDate = d.endDate ? (d.endDate.toDate ? d.endDate.toDate().toLocaleDateString() : new Date(d.endDate).toLocaleDateString()) : 'Illimit√©e';
                    const isActive = d.status === 'active';
                    const statusClass = isActive ? 'active' : (d.status === 'paused' ? 'pending' : 'rejected');
                    const rewardMonths = d.rewardMonths || 3;
                    const subType = d.subscriptionType === 'pro' ? '‚≠ê Pro' : (d.subscriptionType === 'enterprise' ? 'üè¢ Ent.' : 'üöÄ Starter');
                    const maxTotal = (d.maxSponsors || 100) * (d.maxRefereesPerSponsor || 5);

                    tbody.innerHTML += `<tr>
                        <td>${d.name || 'Sans nom'}</td>
                        <td>${subType} √ó ${rewardMonths} mois</td>
                        <td>${d.rewardType === 'both' ? 'üéÅ Double' : (d.rewardType === 'sponsor' ? 'üë§ Parrain' : 'üÜï Filleul')}</td>
                        <td>${startDate} ‚Üí ${endDate}</td>
                        <td>${d.referralsCount || 0} / ${maxTotal}</td>
                        <td>${d.visibleInApp !== false ? 'üëÅÔ∏è Visible' : 'üö´ Masqu√©'}</td>
                        <td><span class="status ${statusClass}">${isActive ? 'Active' : (d.status === 'paused' ? 'Pause' : 'Inactive')}</span></td>
                        <td>
                            <button class="action-btn view" onclick="toggleReferralCampaign('${doc.id}', '${d.status}')">${isActive ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}</button>
                        </td>
                    </tr>`;
                });
            });

            // Listen to referrals collection
            const referralsQ = firebaseUtils.query(
                firebaseUtils.collection(window.db, 'referrals'),
                firebaseUtils.orderBy('createdAt', 'desc'),
                firebaseUtils.limit(20)
            );

            firebaseUtils.onSnapshot(referralsQ, (snapshot) => {
                const tbody = document.getElementById('referralTableBody');
                if (!tbody) return;

                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:var(--text-muted); padding:20px;">Aucun parrainage r√©cent</td></tr>';
                    return;
                }

                tbody.innerHTML = '';
                snapshot.forEach(doc => {
                    const r = doc.data();
                    const date = r.createdAt ? (r.createdAt.toDate ? r.createdAt.toDate().toLocaleDateString() : new Date(r.createdAt).toLocaleDateString()) : '--';
                    const statusClass = r.status === 'validated' ? 'active' : (r.status === 'pending' ? 'pending' : 'rejected');

                    tbody.innerHTML += `< tr >
                        <td>${r.sponsorName || r.sponsorId?.substring(0, 8) || '--'}</td>
                        <td>${r.refereeName || r.refereeId?.substring(0, 8) || '--'}</td>
                        <td><code>${r.code || '--'}</code></td>
                        <td>${date}</td>
                        <td><span class="status ${statusClass}">${r.status === 'validated' ? '‚úÖ Valid√©' : (r.status === 'pending' ? '‚è≥ En attente' : '‚ùå Expir√©')}</span></td>
                        <td><button class="action-btn view" onclick="showDocument('referrals', '${doc.id}')">D√©tails</button></td>
                    </tr > `;
                });
            });
        }

        async function toggleReferralCampaign(campaignId, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'paused' : 'active';
            try {
                await firebaseUtils.updateDoc(
                    firebaseUtils.doc(window.db, 'referral_campaigns', campaignId),
                    { status: newStatus, updatedAt: firebaseUtils.serverTimestamp() }
                );
                console.log('[REFERRAL] Campaign toggled:', campaignId, '->', newStatus);
            } catch (error) {
                console.error('[REFERRAL] Toggle error:', error);
                alert('Erreur: ' + error.message);
            }
        }

        function initCampaignsListener() {
            const tbody = document.getElementById('campaignsTableBody');
            if (!tbody) return;

            const q = firebaseUtils.query(
                firebaseUtils.collection(window.db, 'broadcasts'),
                firebaseUtils.orderBy('createdAt', 'desc'),
                firebaseUtils.limit(5)
            );

            firebaseUtils.onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:var(--text-muted); padding:20px;">Aucune campagne r√©cente</td></tr>';
                    return;
                }
                tbody.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.createdAt ? (data.createdAt.toDate ? data.createdAt.toDate() : new Date(data.createdAt)) : new Date();
                    const row = `< tr >
                        <td>${data.title || 'Campagne sans titre'}</td>
                        <td>${data.type || 'Push'}</td>
                        <td>${data.target || 'Tous'}</td>
                        <td><span class="status active">Envoy√©e</span></td>
                        <td>${date.toLocaleDateString()}</td>
                        <td>-</td>
                        <td><button class="action-btn view" onclick="showDocument('broadcasts', '${doc.id}')">D√©tails</button></td>
                    </tr > `;
                    tbody.innerHTML += row;
                });
            });
        }

        function switchSupportTab(tab) {
            // Hide all tabs
            document.querySelectorAll('.support-tab').forEach(t => t.style.display = 'none');

            // Show selected tab
            const tabElement = document.getElementById('support-' + tab);
            if (tabElement) {
                tabElement.style.display = 'block';
            }

            // Update tab buttons
            const supportCard = document.querySelector('.card:has(.support-tab)');
            if (supportCard) {
                supportCard.querySelectorAll('.tabs .tab').forEach(btn => {
                    btn.classList.remove('active');
                });
                if (window.event && window.event.target) {
                    window.event.target.classList.add('active');
                }
            }
            console.log('[AUDIT] Support tab switched:', tab, new Date().toISOString());
        }

        async function approveLimitRequest(ticketId, userId, newLimits) {
            if (!confirm(`Approuver l'ajustement des limites pour l'utilisateur ${userId} ?\n\nNouveaux salari√©s max: ${newLimits.maxEmployees} \nNouveaux cercles max: ${newLimits.maxCircles} `)) return;

            try {
                const userRef = firebaseUtils.doc(window.db, 'users', userId);
                await firebaseUtils.updateDoc(userRef, {
                    'limits.maxEmployees': newLimits.maxEmployees,
                    'limits.maxCircles': newLimits.maxCircles,
                    'limits.maxMembers': newLimits.maxMembers || 20
                });

                // Update ticket status
                const ticketRef = firebaseUtils.doc(window.db, 'support_tickets', ticketId);
                await firebaseUtils.updateDoc(ticketRef, {
                    status: 'resolved',
                    resolvedAt: firebaseUtils.serverTimestamp(),
                    resolutionNote: 'Approved by Admin'
                });

                alert('‚úÖ Limites mises √† jour et ticket cl√¥tur√© !');
                console.log('[AUDIT] Limit request approved:', { ticketId, userId, newLimits });
            } catch (e) {
                alert('Erreur lors de l\'approbation : ' + e.message);
            }
        }

        async function showOverrideModal() {
            const uid = prompt('Entrez l\'UID de l\'utilisateur/entreprise :');
            if (!uid) return;

            try {
                const userRef = firebaseUtils.doc(window.db, 'users', uid);
                const userSnap = await firebaseUtils.getDoc(userRef);

                if (!userSnap.exists()) {
                    alert('Utilisateur non trouv√©.');
                    return;
                }

                const data = userSnap.data();
                const currentLimits = data.limits || {};

                const newMaxEmployees = prompt('Nouveau nombre max de salari√©s:', currentLimits.maxEmployees || 5);
                const newMaxCircles = prompt('Nouveau nombre max de tontines/cercles:', currentLimits.maxCircles || 1);

                if (newMaxEmployees !== null && newMaxCircles !== null) {
                    await firebaseUtils.updateDoc(userRef, {
                        'limits.maxEmployees': parseInt(newMaxEmployees),
                        'limits.maxCircles': parseInt(newMaxCircles),
                        'last_limit_override_at': firebaseUtils.serverTimestamp()
                    });
                    alert('‚úÖ Override appliqu√© avec succ√®s !');
                    console.log('[AUDIT] Manual override applied for:', uid);
                }
            } catch (e) {
                alert('Erreur: ' + e.message);
            }
        }

        // ============ EXPORT FUNCTIONS ============


        // Download file helper
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.log('[AUDIT] Export:', filename, new Date().toISOString());
        }

        // Get table data as array
        function getTableData(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return [];
            const table = section.tagName === 'TABLE' ? section : section.querySelector('table');
            if (!table) return [];

            const rows = [];
            const headers = [];

            // Get headers
            table.querySelectorAll('thead th').forEach(th => {
                headers.push(th.textContent.trim());
            });
            rows.push(headers);

            // Get data rows
            table.querySelectorAll('tbody tr').forEach(tr => {
                const row = [];
                tr.querySelectorAll('td').forEach(td => {
                    row.push(td.textContent.trim().replace(/"/g, '""'));
                });
                rows.push(row);
            });

            return rows;
        }

        // Export data function
        function exportData(section, format) {
            const timestamp = new Date().toISOString().split('T')[0];
            const data = getTableData(section);

            if (format === 'csv') {
                const csv = data.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
                downloadFile(csv, `tontetic_${section}_${timestamp}.csv`, 'text/csv');
            } else if (format === 'json') {
                const headers = data[0];
                const jsonData = data.slice(1).map(row => {
                    const obj = {};
                    headers.forEach((h, i) => obj[h] = row[i] || '');
                    return obj;
                });
                downloadFile(JSON.stringify(jsonData, null, 2), `tontetic_${section}_${timestamp}.json`, 'application/json');
            }

            // Show success message
            alert(`‚úÖ Export ${format.toUpperCase()} r√©ussi!\n\nFichier: tontetic_${section}_${timestamp}.${format} `);
        }

        // Export all data (for Audit section)
        function exportAllData(format) {
            const sections = ['users', 'circles', 'merchants', 'enterprises', 'reports', 'support', 'campaigns'];
            const allData = {};

            sections.forEach(section => {
                allData[section] = getTableData(section).slice(1); // Skip headers
            });

            const timestamp = new Date().toISOString().split('T')[0];
            if (format === 'json') {
                downloadFile(JSON.stringify(allData, null, 2), `tontetic_full_export_${timestamp}.json`, 'application/json');
            }

            alert(`‚úÖ Export complet r√©ussi!\n\nToutes les sections export√©es.`);
        }

        // ============ SESSION PERSISTENCE (FIX V2) ============

        async function initAuth() {
            try {
                // 1. Force Persistence (Wait for it)
                await firebaseUtils.setPersistence(window.auth, firebaseUtils.browserLocalPersistence);
                console.log('[AUTH] ‚úÖ Persistence set to LOCAL (Browser)');

                // 2. Listen for Auth State
                firebaseUtils.onAuthStateChanged(window.auth, async (user) => {
                    const loginScreen = document.getElementById('loginScreen');
                    const dashboard = document.getElementById('dashboard');

                    if (user) {
                        console.log('[AUTH] ‚úÖ User session restored/active:', user.uid);

                        // Show dashboard, hide login
                        if (loginScreen) loginScreen.style.display = 'none';
                        if (dashboard) dashboard.classList.add('active');

                        // Check Admin Claims again (Security)
                        try {
                            const idTokenResult = await user.getIdTokenResult();
                            const claims = idTokenResult.claims;
                            console.log('[AUTH] Claims verified:', claims);

                            if (!claims.admin && !claims.super_admin) {
                                console.warn('[AUTH] ‚ö†Ô∏è Restored user missing admin claims.');
                                // Optional: Sign out if strict
                            }
                        } catch (e) {
                            console.error('[AUTH] Failed to refresh token:', e);
                        }

                        // Initialize Listeners
                        initRealtimeListeners();
                    } else {
                        console.log('[AUTH] ‚ùå No active session found.');
                        if (loginScreen) loginScreen.style.display = 'flex';
                        if (dashboard) dashboard.classList.remove('active');
                    }
                });
            } catch (error) {
                console.error('[AUTH] Fatal Error initializing auth:', error);
                // Fallback show login
                document.getElementById('loginScreen').style.display = 'flex';
            }
        }

        // Start initialization
        initAuth();
    </script>
</body>

</html>